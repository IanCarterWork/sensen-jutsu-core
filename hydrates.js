import { CompilateErrorException, RenderEngine } from "./compilate";
import { StabilizeEchoExpression, StabilizeSnapCodeExpression } from "./expression";
import { decodeHTMLEntities, StabilizeContent } from "./utilities";
export class ComponentHydratesStore {
    constructor() {
        this.entries = {};
    }
    /**
     * Add
     */
    push(name, record) {
        this.entries[name] = this.entries[name] || [];
        this.entries[name][this.entries[name].length] = record;
        return this;
    }
    /**
     * Add
     */
    update(name, key, record) {
        if (this.entries[name]) {
            if (this.entries[name][key]) {
                this.entries[name][key] = record;
            }
        }
        return this;
    }
    /**
     * Remove entry's slot by Property or State name
     */
    remove(name, key) {
        if (this.entries[name]) {
            this.entries[name] = this.entries[name].filter((record, index) => {
                return index != key;
            });
        }
        return this;
    }
    /**
     * Clean entry by Property or State name
     */
    clean(name) {
        this.entries[name] = [];
        return this;
    }
    /**
     * Clean entry by Property or State name
     */
    reset() {
        this.entries = {};
        return this;
    }
    /**
     * Find by Property or State name
     */
    retrieve(name) {
        return this.entries[name] || undefined;
    }
    /**
     * Find All
     */
    retrieves() {
        return this.entries;
    }
}
export class ComponentHydrates {
    constructor(component, state, props) {
        // entries: TComponentHydratesEntries<S, P> = {} as  TComponentHydratesEntries<S, P>
        // store: TComponentHydratesStore<S, P> = {
        //     state: {} as S,
        //     props: {} as P,
        // } as TComponentHydratesStore<S, P>
        this.component = {};
        this.state = {};
        this.props = {};
        this.$state = {};
        this.$props = {};
        this.component = component;
        this.state = Object.assign({}, state || component.state);
        this.props = props || component.props;
        this.$state = new ComponentHydratesStore();
        this.$props = new ComponentHydratesStore();
        this.proxies();
    }
    setObjectProxy(slot, input) {
        const self = this.component;
        self.state[slot] = new Proxy(input, {
            get: function (target, prop) {
                return target[prop];
            },
            set: function (target, prop, value, prox) {
                target[prop] = value;
                self.hydratesState(slot);
                return true;
            }
        });
        return this;
    }
    setDataProxy(slot) {
        const $ = this;
        const self = this.component;
        Object.defineProperty(self.state, slot, {
            get() { return $.state[slot]; },
            set(value) {
                $.state[slot] = value;
                self.hydratesState(slot);
                return true;
            },
        });
        return this;
    }
    /**
     * Build State Proxies
     * @description Use this to activate the dynamic state. For default the construct call this
     */
    proxies() {
        if (typeof this.state == 'object') {
            const self = this.component;
            const $ = this;
            Object.entries({ ...this.state }).map(e => {
                if (typeof e[1] == 'function') {
                    return;
                }
                const name = e[0];
                /**
                 * Array Proxy
                 */
                if (Array.isArray(e[1])) {
                    this.setObjectProxy(name, [...e[1]]);
                }
                /**
                 * Object Proxy
                 */
                else if (typeof e[1] == 'object') {
                    this.setObjectProxy(name, { ...e[1] });
                }
                /**
                 * Normal Data Proxy
                 */
                else {
                    this.setDataProxy(name);
                }
            });
        }
        return this;
    }
    /**
     * Hydrate Specific Node
     * @description Use this to ReRender state and props in Node
     */
    hydratesNode(node) {
        return new Promise((resolve, reject) => {
            /**
             * Init
             */
            let mockup = StabilizeContent((('innerHTML' in node) ? node.innerHTML : node.textContent) || '');
            /**
             * Echo
             */
            const echoMockup = StabilizeEchoExpression(mockup, true) || '';
            /**
             * SnapCode
             */
            const snapMockup = StabilizeSnapCodeExpression(echoMockup || mockup, true) || '';
            /**
             * Verifications
             */
            if (!echoMockup.length && !snapMockup.length) {
                resolve(null);
                return;
            }
            // console.warn('Compilate SnapCode Exp', snapMockup || echoMockup || mockup)
            /**
             * Rendering
             */
            RenderEngine(snapMockup || echoMockup || mockup, this.component, this.component.state).then(result => {
                if ('innerHTML' in node) {
                    node.innerHTML = result;
                }
                else if ('textContent' in node) {
                    node.textContent = result;
                }
                resolve(result);
            }).catch(er => {
                // CompilateErrorException(er)
                reject(er);
            });
        });
    }
    /**
     * Hydrate Specific Recorde
     * @description Use this to ReRender state and props of Record
     */
    hydratesRecord(record) {
        return new Promise((resolve, reject) => {
            const node = record.node;
            /**
             * Init
             */
            let mockup = StabilizeContent(((record.mockup && 'innerHTML' in record.mockup) ? record.mockup.innerHTML : record.mockup?.textContent) || '');
            /**
             * Echo
             */
            const echoMockup = StabilizeEchoExpression(mockup, true) || '';
            /**
             * SnapCode
             */
            const snapMockup = StabilizeSnapCodeExpression(echoMockup || mockup, true) || '';
            /**
             * Verifications
             */
            if (!echoMockup.length && !snapMockup.length) {
                resolve(null);
                return;
            }
            // console.warn('Compilate SnapCode Exp 2', snapMockup || echoMockup || mockup)
            /**
             * Rendering
             */
            RenderEngine(snapMockup || echoMockup || mockup, this.component, this.component.state).then(result => {
                if ('innerHTML' in node) {
                    node.innerHTML = result;
                }
                else if ('textContent' in node) {
                    result = decodeHTMLEntities(result);
                    node.textContent = `${result}`;
                }
                resolve(result);
            }).catch(er => {
                CompilateErrorException(er);
                reject(er);
            });
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHlkcmF0ZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJoeWRyYXRlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsWUFBWSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3BFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSwyQkFBMkIsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUVwRixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFLbkUsTUFBTSxPQUFPLHNCQUFzQjtJQUFuQztRQUdJLFlBQU8sR0FBK0IsRUFBaUMsQ0FBQTtJQStHM0UsQ0FBQztJQTNHRzs7T0FFRztJQUNGLElBQUksQ0FBQyxJQUFhLEVBQUUsTUFBd0I7UUFFekMsSUFBSSxDQUFDLE9BQU8sQ0FBRSxJQUFJLENBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFFLElBQUksQ0FBRSxJQUFJLEVBQUUsQ0FBQTtRQUVqRCxJQUFJLENBQUMsT0FBTyxDQUFFLElBQUksQ0FBRSxDQUFFLElBQUksQ0FBQyxPQUFPLENBQUUsSUFBSSxDQUFFLENBQUMsTUFBTSxDQUFFLEdBQUcsTUFBTSxDQUFBO1FBRTVELE9BQU8sSUFBSSxDQUFDO0lBRWhCLENBQUM7SUFJRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxJQUFhLEVBQUUsR0FBWSxFQUFFLE1BQXdCO1FBRXhELElBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBRSxJQUFJLENBQUUsRUFBQztZQUVwQixJQUFHLElBQUksQ0FBQyxPQUFPLENBQUUsSUFBSSxDQUFFLENBQUUsR0FBRyxDQUFFLEVBQUM7Z0JBRTNCLElBQUksQ0FBQyxPQUFPLENBQUUsSUFBSSxDQUFFLENBQUUsR0FBRyxDQUFFLEdBQUcsTUFBTSxDQUFBO2FBRXZDO1NBRUo7UUFFRCxPQUFPLElBQUksQ0FBQztJQUVoQixDQUFDO0lBSUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsSUFBYSxFQUFFLEdBQVc7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WUFBWSxDQUFDLFVBQVUsSUFBSSxVQUFVLElBQUksTUFBTSxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFBLEVBQUU7Z0JBRWhHLElBQUcsV0FBVyxJQUFJLElBQUksRUFBQztvQkFFbkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUE7aUJBRTFCO3FCQUVJLElBQUcsYUFBYSxJQUFJLElBQUksRUFBQztvQkFFMUIsTUFBTSxHQUFHLGtCQUFrQixDQUFFLE1BQU0sQ0FBRSxDQUFBO29CQUVyQyxJQUFJLENBQUMsV0FBVyxHQUFHLEdBQUksTUFBTyxFQUFFLENBQUE7aUJBRW5DO2dCQUVELE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUVuQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFBLEVBQUU7Z0JBRVQsdUJBQXVCLENBQUMsRUFBRSxDQUFDLENBQUE7Z0JBRTNCLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUVkLENBQUMsQ0FBQyxDQUFBO1FBR04sQ0FBQyxDQUFDLENBQUE7SUFHTixDQUFDO0NBTUoiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRDb250cm9sbGVyIH0gZnJvbSBcIi5cIjtcbmltcG9ydCB7IENvbXBpbGF0ZUVycm9yRXhjZXB0aW9uLCBSZW5kZXJFbmdpbmUgfSBmcm9tIFwiLi9jb21waWxhdGVcIjtcbmltcG9ydCB7IFN0YWJpbGl6ZUVjaG9FeHByZXNzaW9uLCBTdGFiaWxpemVTbmFwQ29kZUV4cHJlc3Npb24gfSBmcm9tIFwiLi9leHByZXNzaW9uXCI7XG5pbXBvcnQgeyBDb21wb25lbnRNZXRob2RSYXcsIENvbXBvbmVudFByb3BzLCBDb21wb25lbnRTdGF0ZSwgRXhwcmVzc2lvblJlY29yZCwgVENvbXBvbmVudEh5ZHJhdGVzRW50cnkgfSBmcm9tIFwiLi9pbmRleC50XCI7XG5pbXBvcnQgeyBkZWNvZGVIVE1MRW50aXRpZXMsIFN0YWJpbGl6ZUNvbnRlbnQgfSBmcm9tIFwiLi91dGlsaXRpZXNcIjtcblxuXG5cblxuZXhwb3J0IGNsYXNzIENvbXBvbmVudEh5ZHJhdGVzU3RvcmU8VCBleHRlbmRzIChDb21wb25lbnRTdGF0ZSB8IENvbXBvbmVudFByb3BzKT57XG5cblxuICAgIGVudHJpZXM6IFRDb21wb25lbnRIeWRyYXRlc0VudHJ5PFQ+ID0ge30gYXMgIFRDb21wb25lbnRIeWRyYXRlc0VudHJ5PFQ+XG5cblxuXG4gICAgLyoqXG4gICAgICogQWRkXG4gICAgICovXG4gICAgIHB1c2gobmFtZToga2V5b2YgVCwgcmVjb3JkOiBFeHByZXNzaW9uUmVjb3JkKXtcblxuICAgICAgICB0aGlzLmVudHJpZXNbIG5hbWUgXSA9IHRoaXMuZW50cmllc1sgbmFtZSBdIHx8IFtdXG5cbiAgICAgICAgdGhpcy5lbnRyaWVzWyBuYW1lIF1bIHRoaXMuZW50cmllc1sgbmFtZSBdLmxlbmd0aCBdID0gcmVjb3JkXG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIFxuICAgIH1cblxuXG5cbiAgICAvKipcbiAgICAgKiBBZGRcbiAgICAgKi9cbiAgICB1cGRhdGUobmFtZToga2V5b2YgVCwga2V5IDogbnVtYmVyLCByZWNvcmQ6IEV4cHJlc3Npb25SZWNvcmQpe1xuXG4gICAgICAgIGlmKHRoaXMuZW50cmllc1sgbmFtZSBdKXtcblxuICAgICAgICAgICAgaWYodGhpcy5lbnRyaWVzWyBuYW1lIF1bIGtleSBdKXtcbiAgICBcbiAgICAgICAgICAgICAgICB0aGlzLmVudHJpZXNbIG5hbWUgXVsga2V5IF0gPSByZWNvcmRcbiAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIFxuICAgIH1cblxuXG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgZW50cnkncyBzbG90IGJ5IFByb3BlcnR5IG9yIFN0YXRlIG5hbWVcbiAgICAgKi9cbiAgICByZW1vdmUobmFtZToga2V5b2YgVCwga2V5OiBudW1iZXIpe1xuXG4gICAgICAgIGlmKHRoaXMuZW50cmllc1sgbmFtZSBdKXtcblxuICAgICAgICAgICAgdGhpcy5lbnRyaWVzWyBuYW1lIF0gPSB0aGlzLmVudHJpZXNbIG5hbWUgXS5maWx0ZXIoKHJlY29yZCwgaW5kZXgpPT57XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gaW5kZXggIT0ga2V5XG5cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICBcbiAgICB9XG5cblxuXG4gICAgLyoqXG4gICAgICogQ2xlYW4gZW50cnkgYnkgUHJvcGVydHkgb3IgU3RhdGUgbmFtZVxuICAgICAqL1xuICAgIGNsZWFuKG5hbWU6IGtleW9mIFQpe1xuXG4gICAgICAgIHRoaXMuZW50cmllc1sgbmFtZSBdID0gW11cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgXG4gICAgfVxuXG5cblxuICAgIC8qKlxuICAgICAqIENsZWFuIGVudHJ5IGJ5IFByb3BlcnR5IG9yIFN0YXRlIG5hbWVcbiAgICAgKi9cbiAgICByZXNldCgpe1xuXG4gICAgICAgIHRoaXMuZW50cmllcyA9IHt9IGFzIFRDb21wb25lbnRIeWRyYXRlc0VudHJ5PFQ+XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIFxuICAgIH1cblxuXG5cbiAgICAvKipcbiAgICAgKiBGaW5kIGJ5IFByb3BlcnR5IG9yIFN0YXRlIG5hbWVcbiAgICAgKi9cbiAgICByZXRyaWV2ZShuYW1lOiBrZXlvZiBUKSA6IEV4cHJlc3Npb25SZWNvcmRbXXtcblxuICAgICAgICByZXR1cm4gdGhpcy5lbnRyaWVzWyBuYW1lIF0gfHwgdW5kZWZpbmVkXG4gICAgICAgIFxuICAgIH1cblxuXG5cblxuICAgIC8qKlxuICAgICAqIEZpbmQgQWxsXG4gICAgICovXG4gICAgcmV0cmlldmVzKCl7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZW50cmllc1xuICAgICAgICBcbiAgICB9XG5cblxuXG4gICAgXG59XG5cblxuXG5cblxuZXhwb3J0IGNsYXNzIENvbXBvbmVudEh5ZHJhdGVzPFxuXG4gICAgUyBleHRlbmRzIENvbXBvbmVudFN0YXRlLCBcbiAgICBcbiAgICBQIGV4dGVuZHMgQ29tcG9uZW50UHJvcHMsXG4gICAgXG4gICAgTSBleHRlbmRzIENvbXBvbmVudE1ldGhvZFJhdzxTLCBQPlxuICAgIFxuPntcblxuXG4gICAgLy8gZW50cmllczogVENvbXBvbmVudEh5ZHJhdGVzRW50cmllczxTLCBQPiA9IHt9IGFzICBUQ29tcG9uZW50SHlkcmF0ZXNFbnRyaWVzPFMsIFA+XG5cbiAgICAvLyBzdG9yZTogVENvbXBvbmVudEh5ZHJhdGVzU3RvcmU8UywgUD4gPSB7XG5cbiAgICAvLyAgICAgc3RhdGU6IHt9IGFzIFMsXG4gICAgICAgIFxuICAgIC8vICAgICBwcm9wczoge30gYXMgUCxcblxuICAgIC8vIH0gYXMgVENvbXBvbmVudEh5ZHJhdGVzU3RvcmU8UywgUD5cbiAgICBcblxuICAgIGNvbXBvbmVudDogQ29tcG9uZW50Q29udHJvbGxlcjxTLCBQLCBNPiA9IHt9IGFzIENvbXBvbmVudENvbnRyb2xsZXI8UywgUCwgTT5cblxuICAgIHN0YXRlOiBTID0ge30gYXMgU1xuXG4gICAgcHJvcHM6IFAgPSB7fSBhcyBQXG5cblxuXG4gICAgJHN0YXRlOiBDb21wb25lbnRIeWRyYXRlc1N0b3JlPFM+ID0ge30gYXMgQ29tcG9uZW50SHlkcmF0ZXNTdG9yZTxTPlxuXG4gICAgJHByb3BzOiBDb21wb25lbnRIeWRyYXRlc1N0b3JlPFA+ID0ge30gYXMgQ29tcG9uZW50SHlkcmF0ZXNTdG9yZTxQPlxuXG5cbiAgICBcbiAgICBjb25zdHJ1Y3Rvcihjb21wb25lbnQ6IENvbXBvbmVudENvbnRyb2xsZXI8UywgUCwgTT4sIHN0YXRlPzogUywgcHJvcHM/OiBQKXtcblxuICAgICAgICBcbiAgICAgICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7XG4gICAgICAgIFxuICAgICAgICB0aGlzLnN0YXRlID0gT2JqZWN0LmFzc2lnbih7fSwgc3RhdGUgfHwgY29tcG9uZW50LnN0YXRlKTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMucHJvcHMgPSBwcm9wcyB8fCBjb21wb25lbnQucHJvcHM7XG4gICAgICAgIFxuICAgICAgICB0aGlzLiRzdGF0ZSA9IG5ldyBDb21wb25lbnRIeWRyYXRlc1N0b3JlKCk7XG5cbiAgICAgICAgdGhpcy4kcHJvcHMgPSBuZXcgQ29tcG9uZW50SHlkcmF0ZXNTdG9yZSgpO1xuXG5cbiAgICAgICAgdGhpcy5wcm94aWVzKClcblxuICAgIH1cblxuXG5cblxuXG4gICAgc2V0T2JqZWN0UHJveHkoc2xvdDoga2V5b2YgUywgaW5wdXQ6IFNba2V5b2YgU10pe1xuXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzLmNvbXBvbmVudDtcblxuICAgICAgICBzZWxmLnN0YXRlWyBzbG90IF0gPSBuZXcgUHJveHk8U1trZXlvZiBTXT4oaW5wdXQsIHtcblxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbih0YXJnZXQsIHByb3Ape1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRbcHJvcF07XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHRhcmdldCwgcHJvcCwgdmFsdWUsIHByb3gpe1xuXG4gICAgICAgICAgICAgICAgdGFyZ2V0W3Byb3BdID0gdmFsdWVcblxuICAgICAgICAgICAgICAgIHNlbGYuaHlkcmF0ZXNTdGF0ZShzbG90KVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSlcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgXG4gICAgfVxuXG5cblxuXG5cblxuXG5cblxuICAgIHNldERhdGFQcm94eShzbG90OiBrZXlvZiBTKXtcblxuICAgICAgICBjb25zdCAkID0gdGhpcztcblxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcy5jb21wb25lbnQ7XG5cbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHNlbGYuc3RhdGUsIHNsb3QsIHtcblxuICAgICAgICAgICAgZ2V0KCl7IHJldHVybiAkLnN0YXRlWyBzbG90IF07IH0sXG5cbiAgICAgICAgICAgIHNldCh2YWx1ZSl7XG5cbiAgICAgICAgICAgICAgICAkLnN0YXRlWyBzbG90IF0gPSB2YWx1ZVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHNlbGYuaHlkcmF0ZXNTdGF0ZShzbG90KVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuXG4gICAgICAgICAgICB9LFxuXG4gICAgICAgIH0pXG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIFxuICAgIH1cblxuXG5cblxuXG4gICAgXG4gICAgXG4gICAgXG4gICAgXG5cblxuICAgIC8qKlxuICAgICAqIEJ1aWxkIFN0YXRlIFByb3hpZXNcbiAgICAgKiBAZGVzY3JpcHRpb24gVXNlIHRoaXMgdG8gYWN0aXZhdGUgdGhlIGR5bmFtaWMgc3RhdGUuIEZvciBkZWZhdWx0IHRoZSBjb25zdHJ1Y3QgY2FsbCB0aGlzXG4gICAgICovXG4gICAgcHJveGllcygpe1xuXG4gICAgICAgIGlmKHR5cGVvZiB0aGlzLnN0YXRlID09ICdvYmplY3QnKXtcblxuICAgICAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXMuY29tcG9uZW50O1xuXG4gICAgICAgICAgICBjb25zdCAkID0gdGhpcztcblxuICAgICAgICAgICAgT2JqZWN0LmVudHJpZXMoey4uLnRoaXMuc3RhdGV9KS5tYXAoZT0+e1xuXG4gICAgICAgICAgICAgICAgaWYodHlwZW9mIGVbMV0gPT0gJ2Z1bmN0aW9uJyl7IHJldHVybiA7IH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBlWzBdIGFzIGtleW9mIFNcblxuICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAqIEFycmF5IFByb3h5XG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShlWzFdKSl7XG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRPYmplY3RQcm94eShuYW1lLCBbLi4uZVsxXV0gYXMgU1t0eXBlb2YgbmFtZV0gKVxuXG4gICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgKiBPYmplY3QgUHJveHlcbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICBlbHNlIGlmKHR5cGVvZiBlWzFdID09ICdvYmplY3QnKXtcblxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldE9iamVjdFByb3h5KG5hbWUsIHsuLi5lWzFdfSBhcyBTW3R5cGVvZiBuYW1lXSApXG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAqIE5vcm1hbCBEYXRhIFByb3h5XG4gICAgICAgICAgICAgICAgICovXG5cbiAgICAgICAgICAgICAgICBlbHNle1xuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YVByb3h5KG5hbWUpXG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICBcbiAgICB9XG5cblxuXG5cbiAgICAvKipcbiAgICAgKiBIeWRyYXRlIFNwZWNpZmljIE5vZGVcbiAgICAgKiBAZGVzY3JpcHRpb24gVXNlIHRoaXMgdG8gUmVSZW5kZXIgc3RhdGUgYW5kIHByb3BzIGluIE5vZGVcbiAgICAgKi9cbiAgICBoeWRyYXRlc05vZGUobm9kZTogTm9kZSB8IEhUTUxFbGVtZW50KXtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nIHwgbnVsbD4oKHJlc29sdmUsIHJlamVjdCk9PntcblxuXG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogSW5pdFxuICAgICAgICAgICAgICovXG4gICAgXG4gICAgICAgICAgICBsZXQgbW9ja3VwID0gU3RhYmlsaXplQ29udGVudCgoKCdpbm5lckhUTUwnIGluIG5vZGUpID8gbm9kZS5pbm5lckhUTUwgOiBub2RlLnRleHRDb250ZW50KSB8fCAnJykgYXMgc3RyaW5nO1xuICAgICAgICAgICAgXG4gICAgXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIEVjaG9cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgY29uc3QgZWNob01vY2t1cCA9IFN0YWJpbGl6ZUVjaG9FeHByZXNzaW9uKG1vY2t1cCwgdHJ1ZSkgfHwgJydcbiAgICAgXG5cblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBTbmFwQ29kZVxuICAgICAgICAgICAgICovXG5cbiAgICAgICAgICAgIGNvbnN0IHNuYXBNb2NrdXAgPSBTdGFiaWxpemVTbmFwQ29kZUV4cHJlc3Npb24oZWNob01vY2t1cCB8fCBtb2NrdXAsIHRydWUpIHx8ICcnXG5cblxuXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIFZlcmlmaWNhdGlvbnNcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgaWYoIWVjaG9Nb2NrdXAubGVuZ3RoICYmICFzbmFwTW9ja3VwLmxlbmd0aCl7IFxuXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShudWxsKTsgcmV0dXJuOyBcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgXG5cbiAgICAgICAgICAgIC8vIGNvbnNvbGUud2FybignQ29tcGlsYXRlIFNuYXBDb2RlIEV4cCcsIHNuYXBNb2NrdXAgfHwgZWNob01vY2t1cCB8fCBtb2NrdXApXG4gICAgICAgICAgICBcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBSZW5kZXJpbmdcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgUmVuZGVyRW5naW5lKHNuYXBNb2NrdXAgfHwgZWNob01vY2t1cCB8fCBtb2NrdXAsIHRoaXMuY29tcG9uZW50LCB0aGlzLmNvbXBvbmVudC5zdGF0ZSkudGhlbihyZXN1bHQ9PntcbiAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmKCdpbm5lckhUTUwnIGluIG5vZGUpeyBub2RlLmlubmVySFRNTCA9IHJlc3VsdCB9XG5cbiAgICAgICAgICAgICAgICBlbHNlIGlmKCd0ZXh0Q29udGVudCcgaW4gbm9kZSl7IG5vZGUudGV4dENvbnRlbnQgPSByZXN1bHQgfVxuXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpXG4gICAgIFxuICAgICAgICAgICAgfSkuY2F0Y2goZXI9PntcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBDb21waWxhdGVFcnJvckV4Y2VwdGlvbihlcilcbiAgICBcbiAgICAgICAgICAgICAgICByZWplY3QoZXIpXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KVxuXG5cbiAgICAgICAgfSlcbiAgICBcblxuICAgIH1cbiAgICBcbiAgICBcbiAgICBcbiAgICBcbiAgICBcblxuXG5cblxuICAgIC8qKlxuICAgICAqIEh5ZHJhdGUgU3BlY2lmaWMgUmVjb3JkZVxuICAgICAqIEBkZXNjcmlwdGlvbiBVc2UgdGhpcyB0byBSZVJlbmRlciBzdGF0ZSBhbmQgcHJvcHMgb2YgUmVjb3JkXG4gICAgICovXG4gICAgaHlkcmF0ZXNSZWNvcmQocmVjb3JkOiBFeHByZXNzaW9uUmVjb3JkKXtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nIHwgbnVsbD4oKHJlc29sdmUsIHJlamVjdCk9PntcblxuICAgICAgICAgICAgY29uc3Qgbm9kZSA9IHJlY29yZC5ub2RlO1xuXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIEluaXRcbiAgICAgICAgICAgICAqL1xuICAgIFxuICAgICAgICAgICAgbGV0IG1vY2t1cCA9IFN0YWJpbGl6ZUNvbnRlbnQoKChyZWNvcmQubW9ja3VwICYmICdpbm5lckhUTUwnIGluIHJlY29yZC5tb2NrdXApID8gcmVjb3JkLm1vY2t1cC5pbm5lckhUTUwgOiByZWNvcmQubW9ja3VwPy50ZXh0Q29udGVudCkgfHwgJycpIGFzIHN0cmluZztcbiAgICAgICAgICAgIFxuICAgIFxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBFY2hvXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGNvbnN0IGVjaG9Nb2NrdXAgPSBTdGFiaWxpemVFY2hvRXhwcmVzc2lvbihtb2NrdXAsIHRydWUpIHx8ICcnXG4gICAgIFxuXG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogU25hcENvZGVcbiAgICAgICAgICAgICAqL1xuXG4gICAgICAgICAgICBjb25zdCBzbmFwTW9ja3VwID0gU3RhYmlsaXplU25hcENvZGVFeHByZXNzaW9uKGVjaG9Nb2NrdXAgfHwgbW9ja3VwLCB0cnVlKSB8fCAnJ1xuXG5cblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBWZXJpZmljYXRpb25zXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGlmKCFlY2hvTW9ja3VwLmxlbmd0aCAmJiAhc25hcE1vY2t1cC5sZW5ndGgpeyBcblxuICAgICAgICAgICAgICAgIHJlc29sdmUobnVsbCk7IHJldHVybjsgXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgIFxuXG5cblxuICAgICAgICAgICAgLy8gY29uc29sZS53YXJuKCdDb21waWxhdGUgU25hcENvZGUgRXhwIDInLCBzbmFwTW9ja3VwIHx8IGVjaG9Nb2NrdXAgfHwgbW9ja3VwKVxuICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogUmVuZGVyaW5nXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIFJlbmRlckVuZ2luZShzbmFwTW9ja3VwIHx8IGVjaG9Nb2NrdXAgfHwgbW9ja3VwLCB0aGlzLmNvbXBvbmVudCwgdGhpcy5jb21wb25lbnQuc3RhdGUpLnRoZW4ocmVzdWx0PT57XG5cbiAgICAgICAgICAgICAgICBpZignaW5uZXJIVE1MJyBpbiBub2RlKXsgXG5cbiAgICAgICAgICAgICAgICAgICAgbm9kZS5pbm5lckhUTUwgPSByZXN1bHQgXG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBlbHNlIGlmKCd0ZXh0Q29udGVudCcgaW4gbm9kZSl7IFxuXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGRlY29kZUhUTUxFbnRpdGllcyggcmVzdWx0IClcblxuICAgICAgICAgICAgICAgICAgICBub2RlLnRleHRDb250ZW50ID0gYCR7IHJlc3VsdCB9YCBcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KVxuICAgICBcbiAgICAgICAgICAgIH0pLmNhdGNoKGVyPT57XG4gICAgXG4gICAgICAgICAgICAgICAgQ29tcGlsYXRlRXJyb3JFeGNlcHRpb24oZXIpXG4gICAgXG4gICAgICAgICAgICAgICAgcmVqZWN0KGVyKVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSlcblxuXG4gICAgICAgIH0pXG4gICAgXG5cbiAgICB9XG4gICAgXG4gICAgXG4gICAgXG4gICAgXG4gICAgXG59Il19