import { StabilizeEchoExpression, StabilizeSnapCodeExpression, SyDetr, SyntaxEcho } from "./expression";
import { render } from 'ejs';
import { StabilizeContent } from "./utilities";
/**
 * Fragment rendering from String
 */
export async function RenderEngine(input, context, dictionary) {
    return render(`${input}`, dictionary, {
        delimiter: `${SyDetr}`,
        // client: true,
        context: context,
        async: true,
        // includer: (original, parsed)=>{
        //     return {
        //         filename:'',
        //     }
        // }
    });
}
export async function SockRenderEngine(input, context, dictionary) {
    return render(`${input}`, dictionary, {
        delimiter: `${SyDetr}`,
        context: context,
        async: true,
    });
}
export function CompilateErrorException(err) {
    console.error('Compilate Error////', err);
}
export function CompilateEcho(component, record) {
    if (!record.echo) {
        return undefined;
    }
    return new Promise((resolve, reject) => {
        const raw = (record.match) ? record.match[0] : '';
        const expression = ((record.match) ? record.match[1] : '').trim();
        let mockup = record.mockup?.textContent || '';
        /**
         * Prepares
         */
        const matches = [...mockup.matchAll(SyntaxEcho)];
        if (matches.length) {
            matches.map(m => {
                mockup = mockup.replace(new RegExp((m[0]).replace(/[^\w\s]/gi, '\\$&'), 'g'), `<${SyDetr}=${m[1]} ${SyDetr}>`);
            });
        }
        /**
         * Rendering
         */
        RenderEngine((
        // mockup.replace(new RegExp(raw, 'g'), `<${SyDetr}=${ expression } ${SyDetr}>` )
        StabilizeEchoExpression(mockup.replace(new RegExp((raw).replace(/[^\w\s]/gi, '\\$&'), 'g'), `<${SyDetr}=${expression} ${SyDetr}>`)) || ''), component, component.state).then(result => {
            if (record.node instanceof HTMLElement) {
                record.node.innerHTML = result;
            }
            else if (record.node instanceof Node) {
                record.node.textContent = result;
            }
            resolve(record);
        }).catch(er => {
            CompilateErrorException(er);
            reject(er);
        });
    });
}
export function CompilateSnapCode(component, record) {
    if (!record.snapcode) {
        return undefined;
    }
    return new Promise((resolve, reject) => {
        // @ts-ignore
        let mockup = (record.mockup?.innerHTML || record.mockup?.textContent || '');
        mockup = StabilizeContent(mockup);
        record.snapcode?.map(snap => {
            snap.matches.map(match => {
                mockup = mockup.replace(new RegExp((match[0]).replace(/[^\w\s]/gi, '\\$&'), 'g'), `<${SyDetr}${match[1]} ${SyDetr}>`);
            });
        });
        RenderEngine(StabilizeSnapCodeExpression(mockup) || '', component, component.state).then(result => {
            if (record.node instanceof HTMLElement) {
                record.node.innerHTML = result;
            }
            else if (record.node instanceof Node) {
                record.node.textContent = result;
            }
            resolve(record);
        }).catch(er => {
            CompilateErrorException(er);
            reject(er);
        });
    });
}
export function CompilateSnapCodeAttributes(component, record) {
    if (!record.attribute && record.type == 'attribute.snapcode') {
        return undefined;
    }
    return new Promise((resolve, reject) => {
        const name = record.attribute?.name;
        let mockup = (record.mockup?.textContent || '');
        if (record.match) {
            mockup = mockup.replace(new RegExp((record.match[0] || '').replace(/[^\w\s]/gi, '\\$&'), 'g'), `<${SyDetr}${record.match[1]} ${SyDetr}>`);
        }
        RenderEngine(mockup, component, component.state).then(result => {
            if ('attributes' in record.node) {
                record.node.setAttribute(name, result);
            }
            resolve(record);
        }).catch(er => {
            CompilateErrorException(er);
            reject(er);
        });
    });
}
export function CompilateEchoAttributes(component, record) {
    if (!record.attribute && record.type == 'attribute.echo') {
        return undefined;
    }
    return new Promise((resolve, reject) => {
        const name = record.attribute?.name;
        let mockup = (record.mockup?.textContent || '');
        if (record.match) {
            mockup = mockup.replace(new RegExp((record.match[0] || '').replace(/[^\w\s]/gi, '\\$&'), 'g'), `<${SyDetr}=${record.match[1]} ${SyDetr}>`);
        }
        RenderEngine(mockup, component, component.state).then(result => {
            if ('attributes' in record.node) {
                record.node.setAttribute(name, result);
            }
            resolve(record);
        }).catch(er => {
            CompilateErrorException(er);
            reject(er);
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29tcGlsYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSwyQkFBMkIsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRXhHLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFDN0IsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBSS9DOztHQUVHO0FBRUgsTUFBTSxDQUFDLEtBQUssVUFBVSxZQUFZLENBUWhDLEtBQWEsRUFBRSxPQUFxQyxFQUFFLFVBQWtDO0lBRXRGLE9BQU8sTUFBTSxDQUFDLEdBQUksS0FBTSxFQUFFLEVBQUUsVUFBVSxFQUFFO1FBRXBDLFNBQVMsRUFBRSxHQUFJLE1BQU8sRUFBRTtRQUV4QixnQkFBZ0I7UUFFaEIsT0FBTyxFQUFFLE9BQU87UUFFaEIsS0FBSyxFQUFFLElBQUk7UUFFWCxrQ0FBa0M7UUFFbEMsZUFBZTtRQUNmLHVCQUF1QjtRQUN2QixRQUFRO1FBRVIsSUFBSTtLQUVQLENBQUMsQ0FBQTtBQUVOLENBQUM7QUFJRCxNQUFNLENBQUMsS0FBSyxVQUFVLGdCQUFnQixDQUFDLEtBQW9CLEVBQUUsT0FBVyxFQUFFLFVBQWtDO0lBRXhHLE9BQU8sTUFBTSxDQUFDLEdBQUksS0FBTSxFQUFFLEVBQUUsVUFBVSxFQUFFO1FBRXBDLFNBQVMsRUFBRSxHQUFJLE1BQU8sRUFBRTtRQUV4QixPQUFPLEVBQUUsT0FBTztRQUVoQixLQUFLLEVBQUUsSUFBSTtLQUVkLENBQUMsQ0FBQTtBQUVOLENBQUM7QUFJRCxNQUFNLFVBQVUsdUJBQXVCLENBQUMsR0FBUTtJQUU1QyxPQUFPLENBQUMsS0FBSyxDQUFDLHFCQUFxQixFQUFFLEdBQUcsQ0FBRSxDQUFBO0FBRTlDLENBQUM7QUFNRCxNQUFNLFVBQVUsYUFBYSxDQVEzQixTQUF1QyxFQUFFLE1B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QUFBO1FBRWQsQ0FBQyxDQUFDLENBQUE7SUFFTixDQUFDLENBQUMsQ0FBQTtBQUdOLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRDb250cm9sbGVyIH0gZnJvbSBcIi5cIjtcbmltcG9ydCB7IFN0YWJpbGl6ZUVjaG9FeHByZXNzaW9uLCBTdGFiaWxpemVTbmFwQ29kZUV4cHJlc3Npb24sIFN5RGV0ciwgU3ludGF4RWNobyB9IGZyb20gXCIuL2V4cHJlc3Npb25cIjtcbmltcG9ydCB0eXBlIHsgQ29tcG9uZW50TWV0aG9kUmF3LCBDb21wb25lbnRQcm9wcywgQ29tcG9uZW50U3RhdGUsIEV4cHJlc3Npb25SZWNvcmQgfSBmcm9tIFwiLi9pbmRleC50XCI7XG5pbXBvcnQgeyByZW5kZXIgfSBmcm9tICdlanMnO1xuaW1wb3J0IHsgU3RhYmlsaXplQ29udGVudCB9IGZyb20gXCIuL3V0aWxpdGllc1wiO1xuXG5cblxuLyoqXG4gKiBGcmFnbWVudCByZW5kZXJpbmcgZnJvbSBTdHJpbmdcbiAqL1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gUmVuZGVyRW5naW5lPFxuXG4gICAgUyBleHRlbmRzIENvbXBvbmVudFN0YXRlLCBcbiAgICBcbiAgICBQIGV4dGVuZHMgQ29tcG9uZW50UHJvcHMsXG4gICAgXG4gICAgTSBleHRlbmRzIENvbXBvbmVudE1ldGhvZFJhdzxTLCBQPlxuICAgIFxuPihpbnB1dDogc3RyaW5nLCBjb250ZXh0OiBDb21wb25lbnRDb250cm9sbGVyPFMsIFAsIE0+LCBkaWN0aW9uYXJ5OiB7IFtLOiBzdHJpbmddIDogYW55ICB9ICl7XG4gICAgIFxuICAgIHJldHVybiByZW5kZXIoYCR7IGlucHV0IH1gLCBkaWN0aW9uYXJ5LCB7XG4gICAgICAgIFxuICAgICAgICBkZWxpbWl0ZXI6IGAkeyBTeURldHIgfWAsXG4gICAgICAgIFxuICAgICAgICAvLyBjbGllbnQ6IHRydWUsXG5cbiAgICAgICAgY29udGV4dDogY29udGV4dCxcblxuICAgICAgICBhc3luYzogdHJ1ZSxcblxuICAgICAgICAvLyBpbmNsdWRlcjogKG9yaWdpbmFsLCBwYXJzZWQpPT57XG5cbiAgICAgICAgLy8gICAgIHJldHVybiB7XG4gICAgICAgIC8vICAgICAgICAgZmlsZW5hbWU6JycsXG4gICAgICAgIC8vICAgICB9XG5cbiAgICAgICAgLy8gfVxuICAgICAgICBcbiAgICB9KVxuXG59XG5cblxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gU29ja1JlbmRlckVuZ2luZShpbnB1dDogc3RyaW5nIHwgbnVsbCwgY29udGV4dDoge30sIGRpY3Rpb25hcnk6IHsgW0s6IHN0cmluZ10gOiBhbnkgIH0gKXtcbiAgICAgXG4gICAgcmV0dXJuIHJlbmRlcihgJHsgaW5wdXQgfWAsIGRpY3Rpb25hcnksIHtcbiAgICAgICAgXG4gICAgICAgIGRlbGltaXRlcjogYCR7IFN5RGV0ciB9YCxcblxuICAgICAgICBjb250ZXh0OiBjb250ZXh0LFxuXG4gICAgICAgIGFzeW5jOiB0cnVlLFxuXG4gICAgfSlcblxufVxuXG5cblxuZXhwb3J0IGZ1bmN0aW9uIENvbXBpbGF0ZUVycm9yRXhjZXB0aW9uKGVycjogYW55KXtcblxuICAgIGNvbnNvbGUuZXJyb3IoJ0NvbXBpbGF0ZSBFcnJvci8vLy8nLCBlcnIgKVxuXG59XG5cblxuXG5cblxuZXhwb3J0IGZ1bmN0aW9uIENvbXBpbGF0ZUVjaG88XG5cbiAgICBTIGV4dGVuZHMgQ29tcG9uZW50U3RhdGUsIFxuICAgIFxuICAgIFAgZXh0ZW5kcyBDb21wb25lbnRQcm9wcyxcbiAgICBcbiAgICBNIGV4dGVuZHMgQ29tcG9uZW50TWV0aG9kUmF3PFMsIFA+XG4gICAgXG4+KGNvbXBvbmVudDogQ29tcG9uZW50Q29udHJvbGxlcjxTLCBQLCBNPiwgcmVjb3JkOiBFeHByZXNzaW9uUmVjb3JkKXtcblxuICAgIGlmKCFyZWNvcmQuZWNobyl7IHJldHVybiB1bmRlZmluZWQ7fVxuICAgIFxuICAgIHJldHVybiBuZXcgUHJvbWlzZTx0eXBlb2YgcmVjb3JkPigocmVzb2x2ZSwgcmVqZWN0KT0+e1xuXG4gICAgICAgIGNvbnN0IHJhdyA9IChyZWNvcmQubWF0Y2gpID8gcmVjb3JkLm1hdGNoWzBdIDogJyc7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBleHByZXNzaW9uID0gKChyZWNvcmQubWF0Y2gpID8gcmVjb3JkLm1hdGNoWzFdIDogJycpLnRyaW0oKTtcbiAgICAgICAgXG4gICAgICAgIGxldCBtb2NrdXAgPSByZWNvcmQubW9ja3VwPy50ZXh0Q29udGVudCB8fCAnJztcblxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBQcmVwYXJlc1xuICAgICAgICAgKi9cblxuICAgICAgICBjb25zdCBtYXRjaGVzID0gWy4uLm1vY2t1cC5tYXRjaEFsbChTeW50YXhFY2hvKV1cblxuICAgICAgICBpZihtYXRjaGVzLmxlbmd0aCl7XG5cbiAgICAgICAgICAgIG1hdGNoZXMubWFwKG09PntcblxuICAgICAgICAgICAgICAgIG1vY2t1cCA9IG1vY2t1cC5yZXBsYWNlKFxuICAgICAgICAgICAgICAgICAgICBuZXcgUmVnRXhwKCAobVswXSkucmVwbGFjZSgvW15cXHdcXHNdL2dpLCAnXFxcXCQmJykgLCAnZycgKSwgXG4gICAgICAgICAgICAgICAgICAgIGA8JHtTeURldHJ9PSR7IG1bMV0gfSAke1N5RGV0cn0+YCBcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgXG4gICAgICAgIH1cblxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSZW5kZXJpbmdcbiAgICAgICAgICovXG4gICAgICAgIFJlbmRlckVuZ2luZTxTLCBQLCBNPigoXG5cbiAgICAgICAgICAgIC8vIG1vY2t1cC5yZXBsYWNlKG5ldyBSZWdFeHAocmF3LCAnZycpLCBgPCR7U3lEZXRyfT0keyBleHByZXNzaW9uIH0gJHtTeURldHJ9PmAgKVxuXG4gICAgICAgICAgICBTdGFiaWxpemVFY2hvRXhwcmVzc2lvbiggbW9ja3VwLnJlcGxhY2UoIFxuICAgICAgICAgICAgICAgIG5ldyBSZWdFeHAoIChyYXcpLnJlcGxhY2UoL1teXFx3XFxzXS9naSwgJ1xcXFwkJicpICwgJ2cnICksIFxuICAgICAgICAgICAgICAgIGA8JHtTeURldHJ9PSR7IGV4cHJlc3Npb24gfSAke1N5RGV0cn0+YCBcbiAgICAgICAgICAgICkgKSB8fCcnXG5cbiAgICAgICAgKSwgY29tcG9uZW50LCBjb21wb25lbnQuc3RhdGUpLnRoZW4ocmVzdWx0PT57XG5cbiAgICAgICAgICAgIGlmKHJlY29yZC5ub2RlIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpe1xuXG4gICAgICAgICAgICAgICAgcmVjb3JkLm5vZGUuaW5uZXJIVE1MID0gcmVzdWx0O1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYocmVjb3JkLm5vZGUgaW5zdGFuY2VvZiBOb2RlKXtcblxuICAgICAgICAgICAgICAgIHJlY29yZC5ub2RlLnRleHRDb250ZW50ID0gcmVzdWx0XG5cbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICByZXNvbHZlKHJlY29yZClcblxuICAgICAgICB9KS5jYXRjaChlcj0+e1xuXG4gICAgICAgICAgICBDb21waWxhdGVFcnJvckV4Y2VwdGlvbihlcilcblxuICAgICAgICAgICAgcmVqZWN0KGVyKVxuICAgICAgICAgICAgXG4gICAgICAgIH0pXG4gICAgICAgIFxuICAgIH0pXG4gICAgXG4gICAgXG59XG5cblxuXG5cblxuZXhwb3J0IGZ1bmN0aW9uIENvbXBpbGF0ZVNuYXBDb2RlPFxuXG4gICAgUyBleHRlbmRzIENvbXBvbmVudFN0YXRlLCBcbiAgICBcbiAgICBQIGV4dGVuZHMgQ29tcG9uZW50UHJvcHMsXG4gICAgXG4gICAgTSBleHRlbmRzIENvbXBvbmVudE1ldGhvZFJhdzxTLCBQPlxuICAgIFxuPihjb21wb25lbnQ6IENvbXBvbmVudENvbnRyb2xsZXI8UywgUCwgTT4sIHJlY29yZDogRXhwcmVzc2lvblJlY29yZCl7XG5cblxuICAgIGlmKCFyZWNvcmQuc25hcGNvZGUpeyByZXR1cm4gdW5kZWZpbmVkO31cbiAgICBcbiAgICByZXR1cm4gbmV3IFByb21pc2U8dHlwZW9mIHJlY29yZD4oKHJlc29sdmUsIHJlamVjdCk9PntcblxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGxldCBtb2NrdXAgPSAocmVjb3JkLm1vY2t1cD8uaW5uZXJIVE1MIHx8IHJlY29yZC5tb2NrdXA/LnRleHRDb250ZW50IHx8ICcnKSBhcyBzdHJpbmc7XG5cblxuICAgICAgICBtb2NrdXAgPSBTdGFiaWxpemVDb250ZW50KG1vY2t1cClcblxuICAgICAgICByZWNvcmQuc25hcGNvZGU/Lm1hcChzbmFwPT57XG5cbiAgICAgICAgICAgIHNuYXAubWF0Y2hlcy5tYXAobWF0Y2g9PntcblxuICAgICAgICAgICAgICAgIG1vY2t1cCA9IG1vY2t1cC5yZXBsYWNlKCBuZXcgUmVnRXhwKCAobWF0Y2hbMF0pLnJlcGxhY2UoL1teXFx3XFxzXS9naSwgJ1xcXFwkJicpICwgJ2cnICksIGA8JHtTeURldHJ9JHsgbWF0Y2hbMV0gfSAke1N5RGV0cn0+YCApIFxuXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgXG4gICAgICAgIH0pXG5cbiAgICAgICAgXG4gICAgICAgIFJlbmRlckVuZ2luZShTdGFiaWxpemVTbmFwQ29kZUV4cHJlc3Npb24obW9ja3VwKXx8JycsIGNvbXBvbmVudCwgY29tcG9uZW50LnN0YXRlKS50aGVuKHJlc3VsdD0+e1xuXG4gICAgICAgICAgICBpZihyZWNvcmQubm9kZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KXtcblxuICAgICAgICAgICAgICAgIHJlY29yZC5ub2RlLmlubmVySFRNTCA9IHJlc3VsdDtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBlbHNlIGlmKHJlY29yZC5ub2RlIGluc3RhbmNlb2YgTm9kZSl7XG5cbiAgICAgICAgICAgICAgICByZWNvcmQubm9kZS50ZXh0Q29udGVudCA9IHJlc3VsdDtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXNvbHZlKHJlY29yZClcblxuICAgICAgICB9KS5jYXRjaChlcj0+e1xuXG4gICAgICAgICAgICBDb21waWxhdGVFcnJvckV4Y2VwdGlvbihlcilcblxuICAgICAgICAgICAgcmVqZWN0KGVyKVxuICAgICAgICAgICAgXG4gICAgICAgIH0pXG4gICAgICAgIFxuICAgIH0pXG4gICAgXG4gICAgXG59XG5cblxuXG5cblxuZXhwb3J0IGZ1bmN0aW9uIENvbXBpbGF0ZVNuYXBDb2RlQXR0cmlidXRlczxcblxuICAgIFMgZXh0ZW5kcyBDb21wb25lbnRTdGF0ZSwgXG4gICAgXG4gICAgUCBleHRlbmRzIENvbXBvbmVudFByb3BzLFxuICAgIFxuICAgIE0gZXh0ZW5kcyBDb21wb25lbnRNZXRob2RSYXc8UywgUD5cbiAgICBcbj4oY29tcG9uZW50OiBDb21wb25lbnRDb250cm9sbGVyPFMsIFAsIE0+LCByZWNvcmQ6IEV4cHJlc3Npb25SZWNvcmQpe1xuXG5cbiAgICBpZighcmVjb3JkLmF0dHJpYnV0ZSAmJiByZWNvcmQudHlwZSA9PSAnYXR0cmlidXRlLnNuYXBjb2RlJyl7IHJldHVybiB1bmRlZmluZWQ7fVxuICAgIFxuICAgIHJldHVybiBuZXcgUHJvbWlzZTx0eXBlb2YgcmVjb3JkPigocmVzb2x2ZSwgcmVqZWN0KT0+e1xuXG4gICAgICAgIGNvbnN0IG5hbWUgPSByZWNvcmQuYXR0cmlidXRlPy5uYW1lIGFzIHN0cmluZ1xuXG4gICAgICAgIGxldCBtb2NrdXAgPSAocmVjb3JkLm1vY2t1cD8udGV4dENvbnRlbnQgfHwgJycpIGFzIHN0cmluZztcbiAgICAgICAgXG4gICAgICAgIGlmKHJlY29yZC5tYXRjaCl7XG5cbiAgICAgICAgICAgIG1vY2t1cCA9IG1vY2t1cC5yZXBsYWNlKCBuZXcgUmVnRXhwKCAocmVjb3JkLm1hdGNoWzBdfHwnJykucmVwbGFjZSgvW15cXHdcXHNdL2dpLCAnXFxcXCQmJykgLCAnZycgKSwgYDwke1N5RGV0cn0keyByZWNvcmQubWF0Y2hbMV0gfSAke1N5RGV0cn0+YCApIFxuXG4gICAgICAgIH1cblxuICAgICAgICBSZW5kZXJFbmdpbmUobW9ja3VwLCBjb21wb25lbnQsIGNvbXBvbmVudC5zdGF0ZSkudGhlbihyZXN1bHQ9PntcblxuICAgICAgICAgICAgaWYoJ2F0dHJpYnV0ZXMnIGluIHJlY29yZC5ub2RlKXtcblxuICAgICAgICAgICAgICAgIHJlY29yZC5ub2RlLnNldEF0dHJpYnV0ZShuYW1lLCByZXN1bHQpO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJlc29sdmUocmVjb3JkKVxuXG4gICAgICAgIH0pLmNhdGNoKGVyPT57XG5cbiAgICAgICAgICAgIENvbXBpbGF0ZUVycm9yRXhjZXB0aW9uKGVyKVxuXG4gICAgICAgICAgICByZWplY3QoZXIpXG4gICAgICAgICAgICBcbiAgICAgICAgfSlcbiAgICAgICAgXG4gICAgfSlcbiAgICBcbiAgICBcbn1cblxuXG5cblxuXG5leHBvcnQgZnVuY3Rpb24gQ29tcGlsYXRlRWNob0F0dHJpYnV0ZXM8XG5cbiAgICBTIGV4dGVuZHMgQ29tcG9uZW50U3RhdGUsIFxuICAgIFxuICAgIFAgZXh0ZW5kcyBDb21wb25lbnRQcm9wcyxcbiAgICBcbiAgICBNIGV4dGVuZHMgQ29tcG9uZW50TWV0aG9kUmF3PFMsIFA+XG4gICAgXG4+KGNvbXBvbmVudDogQ29tcG9uZW50Q29udHJvbGxlcjxTLCBQLCBNPiwgcmVjb3JkOiBFeHByZXNzaW9uUmVjb3JkKXtcblxuXG4gICAgaWYoIXJlY29yZC5hdHRyaWJ1dGUgJiYgcmVjb3JkLnR5cGUgPT0gJ2F0dHJpYnV0ZS5lY2hvJyl7IHJldHVybiB1bmRlZmluZWQ7fVxuICAgIFxuICAgIHJldHVybiBuZXcgUHJvbWlzZTx0eXBlb2YgcmVjb3JkPigocmVzb2x2ZSwgcmVqZWN0KT0+e1xuXG4gICAgICAgIGNvbnN0IG5hbWUgPSByZWNvcmQuYXR0cmlidXRlPy5uYW1lIGFzIHN0cmluZ1xuXG4gICAgICAgIGxldCBtb2NrdXAgPSAocmVjb3JkLm1vY2t1cD8udGV4dENvbnRlbnQgfHwgJycpIGFzIHN0cmluZztcbiAgICAgICAgXG4gICAgICAgIGlmKHJlY29yZC5tYXRjaCl7XG5cbiAgICAgICAgICAgIG1vY2t1cCA9IG1vY2t1cC5yZXBsYWNlKCBuZXcgUmVnRXhwKCAocmVjb3JkLm1hdGNoWzBdfHwnJykucmVwbGFjZSgvW15cXHdcXHNdL2dpLCAnXFxcXCQmJykgLCAnZycgKSwgYDwke1N5RGV0cn09JHsgcmVjb3JkLm1hdGNoWzFdIH0gJHtTeURldHJ9PmAgKSBcblxuICAgICAgICB9XG5cbiAgICAgICAgUmVuZGVyRW5naW5lKG1vY2t1cCwgY29tcG9uZW50LCBjb21wb25lbnQuc3RhdGUpLnRoZW4ocmVzdWx0PT57XG5cbiAgICAgICAgICAgIGlmKCdhdHRyaWJ1dGVzJyBpbiByZWNvcmQubm9kZSl7XG5cbiAgICAgICAgICAgICAgICByZWNvcmQubm9kZS5zZXRBdHRyaWJ1dGUobmFtZSwgcmVzdWx0KTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXNvbHZlKHJlY29yZClcblxuICAgICAgICB9KS5jYXRjaChlcj0+e1xuXG4gICAgICAgICAgICBDb21waWxhdGVFcnJvckV4Y2VwdGlvbihlcilcblxuICAgICAgICAgICAgcmVqZWN0KGVyKVxuICAgICAgICAgICAgXG4gICAgICAgIH0pXG4gICAgICAgIFxuICAgIH0pXG4gICAgXG4gICAgXG59XG5cblxuXG5cblxuXG4iXX0=