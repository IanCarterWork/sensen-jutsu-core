import { StabilizeEchoExpression, StabilizeSnapCodeExpression, SyDetr, SyntaxEcho } from "./expression";
import { render } from 'ejs';
import { StabilizeContent } from "./utilities";
/**
 * Fragment rendering from String
 */
export async function RenderEngine(input, context, dictionary) {
    return render(`${input}`, dictionary, {
        delimiter: `${SyDetr}`,
        // client: true,
        context: context,
        async: true,
        // includer: (original, parsed)=>{
        //     return {
        //         filename:'',
        //     }
        // }
    });
}
export async function SockRenderEngine(input, context, dictionary) {
    return render(`${input}`, dictionary, {
        delimiter: `${SyDetr}`,
        context: context,
        async: true,
    });
}
export function CompilateErrorException(err) {
    console.error('Compilate Error////', err);
}
export function CompilateEcho(component, record) {
    if (!record.echo) {
        return undefined;
    }
    return new Promise((resolve, reject) => {
        const raw = (record.match) ? record.match[0] : '';
        const expression = ((record.match) ? record.match[1] : '').trim();
        let mockup = record.mockup?.textContent || '';
        /**
         * Prepares
         */
        const matches = [...mockup.matchAll(SyntaxEcho)];
        if (matches.length) {
            matches.map(m => {
                mockup = mockup.replace(new RegExp((m[0]).replace(/[^\w\s]/gi, '\\$&'), 'g'), `<${SyDetr}=${m[1]} ${SyDetr}>`);
            });
        }
        /**
         * Rendering
         */
        RenderEngine((
        // mockup.replace(new RegExp(raw, 'g'), `<${SyDetr}=${ expression } ${SyDetr}>` )
        StabilizeEchoExpression(mockup.replace(new RegExp((raw).replace(/[^\w\s]/gi, '\\$&'), 'g'), `<${SyDetr}=${expression} ${SyDetr}>`)) || ''), component, component.state).then(result => {
            if (record.node instanceof HTMLElement) {
                record.node.innerHTML = result;
            }
            else if (record.node instanceof Node) {
                record.node.textContent = result;
            }
            resolve(record);
        }).catch(er => {
            CompilateErrorException(er);
            reject(er);
        });
    });
}
export function CompilateSnapCode(component, record) {
    if (!record.snapcode) {
        return undefined;
    }
    return new Promise((resolve, reject) => {
        // @ts-ignore
        let mockup = (record.mockup?.innerHTML || record.mockup?.textContent || '');
        mockup = StabilizeContent(mockup);
        record.snapcode?.map(snap => {
            snap.matches.map(match => {
                mockup = mockup.replace(new RegExp((match[0]).replace(/[^\w\s]/gi, '\\$&'), 'g'), `<${SyDetr}${match[1]} ${SyDetr}>`);
            });
        });
        RenderEngine(StabilizeSnapCodeExpression(mockup) || '', component, component.state).then(result => {
            if (record.node instanceof HTMLElement) {
                record.node.innerHTML = result;
            }
            else if (record.node instanceof Node) {
                record.node.textContent = result;
            }
            resolve(record);
        }).catch(er => {
            CompilateErrorException(er);
            reject(er);
        });
    });
}
export function CompilateSnapCodeAttributes(component, record) {
    if (!record.attribute && record.type == 'attribute.snapcode') {
        return undefined;
    }
    return new Promise((resolve, reject) => {
        const name = record.attribute?.name;
        let mockup = (record.mockup?.textContent || '');
        if (record.match) {
            mockup = mockup.replace(new RegExp((record.match[0] || '').replace(/[^\w\s]/gi, '\\$&'), 'g'), `<${SyDetr}${record.match[1]} ${SyDetr}>`);
        }
        RenderEngine(mockup, component, component.state).then(result => {
            if ('attributes' in record.node) {
                record.node.setAttribute(name, result);
            }
            resolve(record);
        }).catch(er => {
            CompilateErrorException(er);
            reject(er);
        });
    });
}
export function CompilateEchoAttributes(component, record) {
    if (!record.attribute && record.type == 'attribute.echo') {
        return undefined;
    }
    return new Promise((resolve, reject) => {
        const name = record.attribute?.name;
        let mockup = (record.mockup?.textContent || '');
        if (record.match) {
            mockup = mockup.replace(new RegExp((record.match[0] || '').replace(/[^\w\s]/gi, '\\$&'), 'g'), `<${SyDetr}=${record.match[1]} ${SyDetr}>`);
        }
        RenderEngine(mockup, component, component.state).then(result => {
            if ('attributes' in record.node) {
                record.node.setAttribute(name, result);
            }
            resolve(record);
        }).catch(er => {
            CompilateErrorException(er);
            reject(er);
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vY29yZS9jb21waWxhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLHVCQUF1QixFQUFFLDJCQUEyQixFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFeEcsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEtBQUssQ0FBQztBQUM3QixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFJL0M7O0dBRUc7QUFFSCxNQUFNLENBQUMsS0FBSyxVQUFVLFlBQVksQ0FRaEMsS0FBYSxFQUFFLE9BQXFDLEVBQUUsVUFBa0M7SUFFdEYsT0FBTyxNQUFNLENBQUMsR0FBSSxLQUFNLEVBQUUsRUFBRSxVQUFVLEVBQUU7UUFFcEMsU0FBUyxFQUFFLEdBQUksTUFBTyxFQUFFO1FBRXhCLGdCQUFnQjtRQUVoQixPQUFPLEVBQUUsT0FBTztRQUVoQixLQUFLLEVBQUUsSUFBSTtRQUVYLGtDQUFrQztRQUVsQyxlQUFlO1FBQ2YsdUJBQXVCO1FBQ3ZCLFFBQVE7UUFFUixJQUFJO0tBRVAsQ0FBQyxDQUFBO0FBRU4sQ0FBQztBQUlELE1BQU0sQ0FBQyxLQUFLLFVBQVUsZ0JBQWdCLENBQUMsS0FBb0IsRUFBRSxPQUFXLEVBQUUsVUFBa0M7SUFFeEcsT0FBTyxNQUFNLENBQUMsR0FBSSxLQUFNLEVBQUUsRUFBRSxVQUFVLEVBQUU7UUFFcEMsU0FBUyxFQUFFLEdBQUksTUFBTyxFQUFFO1FBRXhCLE9BQU8sRUFBRSxPQUFPO1FBRWhCLEtBQUssRUFBRSxJQUFJO0tBRWQsQ0FBQyxDQUFBO0FBRU4sQ0FBQztBQUlELE1BQU0sVUFBVSx1QkFBdUIsQ0FBQyxHQUFRO0lBRTVDLE9BQU8sQ0FBQyxLQUFLLENBQUMscUJBQXFCLEVBQUUsR0FBRyxDQUFFLENBQUE7QUFFOUMsQ0FBQztBQU1ELE1BQU0sVUFBVSxhQUFhLENBUTNCLFNBQXVDLEVBQUUsTUFBd0I7SUFFL0QsSUFBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUM7UUFBRSxPQUFPLFNBQVMsQ0FBQztLQUFDO0lBRXBDLE9BQU8sSUFBSSxPQUFPLENBQWdCLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBQyxFQUFFO1FBRWpELE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFFbEQsTUFBTSxVQUFVLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFbEUsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxXQUFXLElBQUksRUFBRSxDQUFDO1FBRzlDOztXQUVHO1FBRUgsTUFBTSxPQUFPLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQTtRQUVoRCxJQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUM7WUFFZCxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQSxFQUFFO2dCQUVYLE1BQU0sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUNuQixJQUFJLE1BQU0sQ0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLEVBQUcsR0FBRyxDQUFFLEVBQ3ZELElBQUksTUFBTSxJQUFLLENBQUMsQ0FBQyxDQUFDLENBQUUsSUFBSSxNQUFNLEdBQUcsQ0FDcEMsQ0FBQTtZQUVMLENBQUMsQ0FBQyxDQUFBO1NBRUw7UUFHRDs7V0FFRztRQUNILFlBQVksQ0FBVTtRQUVsQixpRkFBaUY7UUFFakYsdUJBQXVCLENBQUUsTUFBTSxDQUFDLE9BQU8sQ0FDbkMsSUFBSSxNQUFNLENBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxFQUFHLEdBQUcsQ0FBRSxFQUN0RCxJQUFJLE1BQU0sSUFBSyxVQUFXLElBQUksTUFBTSxHQUFHLENBQzFDLENBQUUsSUFBRyxFQUFFLENBRVgsRUFBRSxTQUFTLEVBQUUsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUEsRUFBRTtZQUV4QyxJQUFHLE1BQU0sQ0FBQyxJQUFJLFlBQVksV0FBVyxFQUFDO2dCQUVsQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUM7YUFFbEM7aUJBRUksSUFBRyxNQUFNLENBQUMsSUFBSSxZQUFZLElBQUksRUFBQztnQkFFaEMsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFBO2FBRW5DO1lBR0QsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBRW5CLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUEsRUFBRTtZQUVULHVCQUF1QixDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBRTNCLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUVkLENBQUMsQ0FBQyxDQUFBO0lBRU4sQ0FBQyxDQUFDLENBQUE7QUFHTixDQUFDO0FBTUQsTUFBTSxVQUFVLGlCQUFpQixDQVEvQixTQUF1QyxFQUFFLE1BQXdCO0lBRy9ELElBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFDO1FBQUUsT0FBTyxTQUFTLENBQUM7S0FBQztJQUV4QyxPQUFPLElBQUksT0FBTyxDQUFnQixDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUMsRUFBRTtRQUVqRCxhQUFhO1FBQ2IsSUFBSSxNQUFNLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLFNBQVMsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFLFdBQVcsSUFBSSxFQUFFLENBQVcsQ0FBQztRQUd0RixNQUFNLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUE7UUFFakMsTUFBTSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFBLEVBQUU7WUFFdkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFBLEVBQUU7Z0JBRXBCLE1BQU0sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFFLElBQUksTUFBTSxDQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsRUFBRyxHQUFHLENBQUUsRUFBRSxJQUFJLE1BQU0sR0FBSSxLQUFLLENBQUMsQ0FBQyxDQUFFLElBQUksTUFBTSxHQUFHLENBQUUsQ0FBQTtZQUVoSSxDQUFDLENBQUMsQ0FBQTtRQUVOLENBQUMsQ0FBQyxDQUFBO1FBR0YsWUFBWSxDQUFDLDJCQUEyQixDQUFDLE1BQU0sQ0FBQyxJQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUEsRUFBRTtZQUUzRixJQUFHLE1BQU0sQ0FBQyxJQUFJLFlBQVksV0FBVyxFQUFDO2dCQUVsQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUM7YUFFbEM7aUJBRUksSUFBRyxNQUFNLENBQUMsSUFBSSxZQUFZLElBQUksRUFBQztnQkFFaEMsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDO2FBRXBDO1lBRUQsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBRW5CLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUEsRUFBRTtZQUVULHVCQUF1QixDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBRTNCLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUVkLENBQUMsQ0FBQyxDQUFBO0lBRU4sQ0FBQyxDQUFDLENBQUE7QUFHTixDQUFDO0FBTUQsTUFBTSxVQUFVLDJCQUEyQixDQVF6QyxTQUF1QyxFQUFFLE1BQXdCO0lBRy9ELElBQUcsQ0FBQyxNQUFNLENBQUMsU0FBUyxJQUFJLE1BQU0sQ0FBQyxJQUFJLElBQUksb0JBQW9CLEVBQUM7UUFBRSxPQUFPLFNBQVMsQ0FBQztLQUFDO0lBRWhGLE9BQU8sSUFBSSxPQUFPLENBQWdCLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBQyxFQUFFO1FBRWpELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsSUFBYyxDQUFBO1FBRTdDLElBQUksTUFBTSxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxXQUFXLElBQUksRUFBRSxDQUFXLENBQUM7UUFFMUQsSUFBRyxNQUFNLENBQUMsS0FBSyxFQUFDO1lBRVosTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUUsSUFBSSxNQUFNLENBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFFLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLEVBQUcsR0FBRyxDQUFFLEVBQUUsSUFBSSxNQUFNLEdBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUUsSUFBSSxNQUFNLEdBQUcsQ0FBRSxDQUFBO1NBRWpKO1FBRUQsWUFBWSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUEsRUFBRTtZQUUxRCxJQUFHLFlBQVksSUFBSSxNQUFNLENBQUMsSUFBSSxFQUFDO2dCQUUzQixNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7YUFFMUM7WUFFRCxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7UUFFbkIsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQSxFQUFFO1lBRVQsdUJBQXVCLENBQUMsRUFBRSxDQUFDLENBQUE7WUFFM0IsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBRWQsQ0FBQyxDQUFDLENBQUE7SUFFTixDQUFDLENBQUMsQ0FBQTtBQUdOLENBQUM7QUFNRCxNQUFNLFVBQVUsdUJBQXVCLENBUXJDLFNBQXVDLEVBQUUsTUFBd0I7SUFHL0QsSUFBRyxDQUFDLE1BQU0sQ0FBQyxTQUFTLElBQUksTUFBTSxDQUFDLElBQUksSUFBSSxnQkFBZ0IsRUFBQztRQUFFLE9BQU8sU0FBUyxDQUFDO0tBQUM7SUFFNUUsT0FBTyxJQUFJLE9BQU8sQ0FBZ0IsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFDLEVBQUU7UUFFakQsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxJQUFjLENBQUE7UUFFN0MsSUFBSSxNQUFNLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLFdBQVcsSUFBSSxFQUFFLENBQVcsQ0FBQztRQUUxRCxJQUFHLE1BQU0sQ0FBQyxLQUFLLEVBQUM7WUFFWixNQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBRSxJQUFJLE1BQU0sQ0FBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUUsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsRUFBRyxHQUFHLENBQUUsRUFBRSxJQUFJLE1BQU0sSUFBSyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBRSxJQUFJLE1BQU0sR0FBRyxDQUFFLENBQUE7U0FFbEo7UUFFRCxZQUFZLENBQUMsTUFBTSxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQSxFQUFFO1lBRTFELElBQUcsWUFBWSxJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUM7Z0JBRTNCLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQzthQUUxQztZQUVELE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUVuQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFBLEVBQUU7WUFFVCx1QkFBdUIsQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUUzQixNQUFNLENBQUMsRUFBRSxDQUFDLENBQUE7UUFFZCxDQUFDLENBQUMsQ0FBQTtJQUVOLENBQUMsQ0FBQyxDQUFBO0FBR04sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudENvbnRyb2xsZXIgfSBmcm9tIFwiLlwiO1xuaW1wb3J0IHsgU3RhYmlsaXplRWNob0V4cHJlc3Npb24sIFN0YWJpbGl6ZVNuYXBDb2RlRXhwcmVzc2lvbiwgU3lEZXRyLCBTeW50YXhFY2hvIH0gZnJvbSBcIi4vZXhwcmVzc2lvblwiO1xuaW1wb3J0IHR5cGUgeyBDb21wb25lbnRNZXRob2RSYXcsIENvbXBvbmVudFByb3BzLCBDb21wb25lbnRTdGF0ZSwgRXhwcmVzc2lvblJlY29yZCB9IGZyb20gXCIuL2luZGV4LnRcIjtcbmltcG9ydCB7IHJlbmRlciB9IGZyb20gJ2Vqcyc7XG5pbXBvcnQgeyBTdGFiaWxpemVDb250ZW50IH0gZnJvbSBcIi4vdXRpbGl0aWVzXCI7XG5cblxuXG4vKipcbiAqIEZyYWdtZW50IHJlbmRlcmluZyBmcm9tIFN0cmluZ1xuICovXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBSZW5kZXJFbmdpbmU8XG5cbiAgICBTIGV4dGVuZHMgQ29tcG9uZW50U3RhdGUsIFxuICAgIFxuICAgIFAgZXh0ZW5kcyBDb21wb25lbnRQcm9wcyxcbiAgICBcbiAgICBNIGV4dGVuZHMgQ29tcG9uZW50TWV0aG9kUmF3PFMsIFA+XG4gICAgXG4+KGlucHV0OiBzdHJpbmcsIGNvbnRleHQ6IENvbXBvbmVudENvbnRyb2xsZXI8UywgUCwgTT4sIGRpY3Rpb25hcnk6IHsgW0s6IHN0cmluZ10gOiBhbnkgIH0gKXtcbiAgICAgXG4gICAgcmV0dXJuIHJlbmRlcihgJHsgaW5wdXQgfWAsIGRpY3Rpb25hcnksIHtcbiAgICAgICAgXG4gICAgICAgIGRlbGltaXRlcjogYCR7IFN5RGV0ciB9YCxcbiAgICAgICAgXG4gICAgICAgIC8vIGNsaWVudDogdHJ1ZSxcblxuICAgICAgICBjb250ZXh0OiBjb250ZXh0LFxuXG4gICAgICAgIGFzeW5jOiB0cnVlLFxuXG4gICAgICAgIC8vIGluY2x1ZGVyOiAob3JpZ2luYWwsIHBhcnNlZCk9PntcblxuICAgICAgICAvLyAgICAgcmV0dXJuIHtcbiAgICAgICAgLy8gICAgICAgICBmaWxlbmFtZTonJyxcbiAgICAgICAgLy8gICAgIH1cblxuICAgICAgICAvLyB9XG4gICAgICAgIFxuICAgIH0pXG5cbn1cblxuXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBTb2NrUmVuZGVyRW5naW5lKGlucHV0OiBzdHJpbmcgfCBudWxsLCBjb250ZXh0OiB7fSwgZGljdGlvbmFyeTogeyBbSzogc3RyaW5nXSA6IGFueSAgfSApe1xuICAgICBcbiAgICByZXR1cm4gcmVuZGVyKGAkeyBpbnB1dCB9YCwgZGljdGlvbmFyeSwge1xuICAgICAgICBcbiAgICAgICAgZGVsaW1pdGVyOiBgJHsgU3lEZXRyIH1gLFxuXG4gICAgICAgIGNvbnRleHQ6IGNvbnRleHQsXG5cbiAgICAgICAgYXN5bmM6IHRydWUsXG5cbiAgICB9KVxuXG59XG5cblxuXG5leHBvcnQgZnVuY3Rpb24gQ29tcGlsYXRlRXJyb3JFeGNlcHRpb24oZXJyOiBhbnkpe1xuXG4gICAgY29uc29sZS5lcnJvcignQ29tcGlsYXRlIEVycm9yLy8vLycsIGVyciApXG5cbn1cblxuXG5cblxuXG5leHBvcnQgZnVuY3Rpb24gQ29tcGlsYXRlRWNobzxcblxuICAgIFMgZXh0ZW5kcyBDb21wb25lbnRTdGF0ZSwgXG4gICAgXG4gICAgUCBleHRlbmRzIENvbXBvbmVudFByb3BzLFxuICAgIFxuICAgIE0gZXh0ZW5kcyBDb21wb25lbnRNZXRob2RSYXc8UywgUD5cbiAgICBcbj4oY29tcG9uZW50OiBDb21wb25lbnRDb250cm9sbGVyPFMsIFAsIE0+LCByZWNvcmQ6IEV4cHJlc3Npb25SZWNvcmQpe1xuXG4gICAgaWYoIXJlY29yZC5lY2hvKXsgcmV0dXJuIHVuZGVmaW5lZDt9XG4gICAgXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHR5cGVvZiByZWNvcmQ+KChyZXNvbHZlLCByZWplY3QpPT57XG5cbiAgICAgICAgY29uc3QgcmF3ID0gKHJlY29yZC5tYXRjaCkgPyByZWNvcmQubWF0Y2hbMF0gOiAnJztcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGV4cHJlc3Npb24gPSAoKHJlY29yZC5tYXRjaCkgPyByZWNvcmQubWF0Y2hbMV0gOiAnJykudHJpbSgpO1xuICAgICAgICBcbiAgICAgICAgbGV0IG1vY2t1cCA9IHJlY29yZC5tb2NrdXA/LnRleHRDb250ZW50IHx8ICcnO1xuXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFByZXBhcmVzXG4gICAgICAgICAqL1xuXG4gICAgICAgIGNvbnN0IG1hdGNoZXMgPSBbLi4ubW9ja3VwLm1hdGNoQWxsKFN5bnRheEVjaG8pXVxuXG4gICAgICAgIGlmKG1hdGNoZXMubGVuZ3RoKXtcblxuICAgICAgICAgICAgbWF0Y2hlcy5tYXAobT0+e1xuXG4gICAgICAgICAgICAgICAgbW9ja3VwID0gbW9ja3VwLnJlcGxhY2UoXG4gICAgICAgICAgICAgICAgICAgIG5ldyBSZWdFeHAoIChtWzBdKS5yZXBsYWNlKC9bXlxcd1xcc10vZ2ksICdcXFxcJCYnKSAsICdnJyApLCBcbiAgICAgICAgICAgICAgICAgICAgYDwke1N5RGV0cn09JHsgbVsxXSB9ICR7U3lEZXRyfT5gIFxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBcbiAgICAgICAgfVxuXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJlbmRlcmluZ1xuICAgICAgICAgKi9cbiAgICAgICAgUmVuZGVyRW5naW5lPFMsIFAsIE0+KChcblxuICAgICAgICAgICAgLy8gbW9ja3VwLnJlcGxhY2UobmV3IFJlZ0V4cChyYXcsICdnJyksIGA8JHtTeURldHJ9PSR7IGV4cHJlc3Npb24gfSAke1N5RGV0cn0+YCApXG5cbiAgICAgICAgICAgIFN0YWJpbGl6ZUVjaG9FeHByZXNzaW9uKCBtb2NrdXAucmVwbGFjZSggXG4gICAgICAgICAgICAgICAgbmV3IFJlZ0V4cCggKHJhdykucmVwbGFjZSgvW15cXHdcXHNdL2dpLCAnXFxcXCQmJykgLCAnZycgKSwgXG4gICAgICAgICAgICAgICAgYDwke1N5RGV0cn09JHsgZXhwcmVzc2lvbiB9ICR7U3lEZXRyfT5gIFxuICAgICAgICAgICAgKSApIHx8JydcblxuICAgICAgICApLCBjb21wb25lbnQsIGNvbXBvbmVudC5zdGF0ZSkudGhlbihyZXN1bHQ9PntcblxuICAgICAgICAgICAgaWYocmVjb3JkLm5vZGUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCl7XG5cbiAgICAgICAgICAgICAgICByZWNvcmQubm9kZS5pbm5lckhUTUwgPSByZXN1bHQ7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZWxzZSBpZihyZWNvcmQubm9kZSBpbnN0YW5jZW9mIE5vZGUpe1xuXG4gICAgICAgICAgICAgICAgcmVjb3JkLm5vZGUudGV4dENvbnRlbnQgPSByZXN1bHRcblxuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIHJlc29sdmUocmVjb3JkKVxuXG4gICAgICAgIH0pLmNhdGNoKGVyPT57XG5cbiAgICAgICAgICAgIENvbXBpbGF0ZUVycm9yRXhjZXB0aW9uKGVyKVxuXG4gICAgICAgICAgICByZWplY3QoZXIpXG4gICAgICAgICAgICBcbiAgICAgICAgfSlcbiAgICAgICAgXG4gICAgfSlcbiAgICBcbiAgICBcbn1cblxuXG5cblxuXG5leHBvcnQgZnVuY3Rpb24gQ29tcGlsYXRlU25hcENvZGU8XG5cbiAgICBTIGV4dGVuZHMgQ29tcG9uZW50U3RhdGUsIFxuICAgIFxuICAgIFAgZXh0ZW5kcyBDb21wb25lbnRQcm9wcyxcbiAgICBcbiAgICBNIGV4dGVuZHMgQ29tcG9uZW50TWV0aG9kUmF3PFMsIFA+XG4gICAgXG4+KGNvbXBvbmVudDogQ29tcG9uZW50Q29udHJvbGxlcjxTLCBQLCBNPiwgcmVjb3JkOiBFeHByZXNzaW9uUmVjb3JkKXtcblxuXG4gICAgaWYoIXJlY29yZC5zbmFwY29kZSl7IHJldHVybiB1bmRlZmluZWQ7fVxuICAgIFxuICAgIHJldHVybiBuZXcgUHJvbWlzZTx0eXBlb2YgcmVjb3JkPigocmVzb2x2ZSwgcmVqZWN0KT0+e1xuXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgbGV0IG1vY2t1cCA9IChyZWNvcmQubW9ja3VwPy5pbm5lckhUTUwgfHwgcmVjb3JkLm1vY2t1cD8udGV4dENvbnRlbnQgfHwgJycpIGFzIHN0cmluZztcblxuXG4gICAgICAgIG1vY2t1cCA9IFN0YWJpbGl6ZUNvbnRlbnQobW9ja3VwKVxuXG4gICAgICAgIHJlY29yZC5zbmFwY29kZT8ubWFwKHNuYXA9PntcblxuICAgICAgICAgICAgc25hcC5tYXRjaGVzLm1hcChtYXRjaD0+e1xuXG4gICAgICAgICAgICAgICAgbW9ja3VwID0gbW9ja3VwLnJlcGxhY2UoIG5ldyBSZWdFeHAoIChtYXRjaFswXSkucmVwbGFjZSgvW15cXHdcXHNdL2dpLCAnXFxcXCQmJykgLCAnZycgKSwgYDwke1N5RGV0cn0keyBtYXRjaFsxXSB9ICR7U3lEZXRyfT5gICkgXG5cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBcbiAgICAgICAgfSlcblxuICAgICAgICBcbiAgICAgICAgUmVuZGVyRW5naW5lKFN0YWJpbGl6ZVNuYXBDb2RlRXhwcmVzc2lvbihtb2NrdXApfHwnJywgY29tcG9uZW50LCBjb21wb25lbnQuc3RhdGUpLnRoZW4ocmVzdWx0PT57XG5cbiAgICAgICAgICAgIGlmKHJlY29yZC5ub2RlIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpe1xuXG4gICAgICAgICAgICAgICAgcmVjb3JkLm5vZGUuaW5uZXJIVE1MID0gcmVzdWx0O1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYocmVjb3JkLm5vZGUgaW5zdGFuY2VvZiBOb2RlKXtcblxuICAgICAgICAgICAgICAgIHJlY29yZC5ub2RlLnRleHRDb250ZW50ID0gcmVzdWx0O1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJlc29sdmUocmVjb3JkKVxuXG4gICAgICAgIH0pLmNhdGNoKGVyPT57XG5cbiAgICAgICAgICAgIENvbXBpbGF0ZUVycm9yRXhjZXB0aW9uKGVyKVxuXG4gICAgICAgICAgICByZWplY3QoZXIpXG4gICAgICAgICAgICBcbiAgICAgICAgfSlcbiAgICAgICAgXG4gICAgfSlcbiAgICBcbiAgICBcbn1cblxuXG5cblxuXG5leHBvcnQgZnVuY3Rpb24gQ29tcGlsYXRlU25hcENvZGVBdHRyaWJ1dGVzPFxuXG4gICAgUyBleHRlbmRzIENvbXBvbmVudFN0YXRlLCBcbiAgICBcbiAgICBQIGV4dGVuZHMgQ29tcG9uZW50UHJvcHMsXG4gICAgXG4gICAgTSBleHRlbmRzIENvbXBvbmVudE1ldGhvZFJhdzxTLCBQPlxuICAgIFxuPihjb21wb25lbnQ6IENvbXBvbmVudENvbnRyb2xsZXI8UywgUCwgTT4sIHJlY29yZDogRXhwcmVzc2lvblJlY29yZCl7XG5cblxuICAgIGlmKCFyZWNvcmQuYXR0cmlidXRlICYmIHJlY29yZC50eXBlID09ICdhdHRyaWJ1dGUuc25hcGNvZGUnKXsgcmV0dXJuIHVuZGVmaW5lZDt9XG4gICAgXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHR5cGVvZiByZWNvcmQ+KChyZXNvbHZlLCByZWplY3QpPT57XG5cbiAgICAgICAgY29uc3QgbmFtZSA9IHJlY29yZC5hdHRyaWJ1dGU/Lm5hbWUgYXMgc3RyaW5nXG5cbiAgICAgICAgbGV0IG1vY2t1cCA9IChyZWNvcmQubW9ja3VwPy50ZXh0Q29udGVudCB8fCAnJykgYXMgc3RyaW5nO1xuICAgICAgICBcbiAgICAgICAgaWYocmVjb3JkLm1hdGNoKXtcblxuICAgICAgICAgICAgbW9ja3VwID0gbW9ja3VwLnJlcGxhY2UoIG5ldyBSZWdFeHAoIChyZWNvcmQubWF0Y2hbMF18fCcnKS5yZXBsYWNlKC9bXlxcd1xcc10vZ2ksICdcXFxcJCYnKSAsICdnJyApLCBgPCR7U3lEZXRyfSR7IHJlY29yZC5tYXRjaFsxXSB9ICR7U3lEZXRyfT5gICkgXG5cbiAgICAgICAgfVxuXG4gICAgICAgIFJlbmRlckVuZ2luZShtb2NrdXAsIGNvbXBvbmVudCwgY29tcG9uZW50LnN0YXRlKS50aGVuKHJlc3VsdD0+e1xuXG4gICAgICAgICAgICBpZignYXR0cmlidXRlcycgaW4gcmVjb3JkLm5vZGUpe1xuXG4gICAgICAgICAgICAgICAgcmVjb3JkLm5vZGUuc2V0QXR0cmlidXRlKG5hbWUsIHJlc3VsdCk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmVzb2x2ZShyZWNvcmQpXG5cbiAgICAgICAgfSkuY2F0Y2goZXI9PntcblxuICAgICAgICAgICAgQ29tcGlsYXRlRXJyb3JFeGNlcHRpb24oZXIpXG5cbiAgICAgICAgICAgIHJlamVjdChlcilcbiAgICAgICAgICAgIFxuICAgICAgICB9KVxuICAgICAgICBcbiAgICB9KVxuICAgIFxuICAgIFxufVxuXG5cblxuXG5cbmV4cG9ydCBmdW5jdGlvbiBDb21waWxhdGVFY2hvQXR0cmlidXRlczxcblxuICAgIFMgZXh0ZW5kcyBDb21wb25lbnRTdGF0ZSwgXG4gICAgXG4gICAgUCBleHRlbmRzIENvbXBvbmVudFByb3BzLFxuICAgIFxuICAgIE0gZXh0ZW5kcyBDb21wb25lbnRNZXRob2RSYXc8UywgUD5cbiAgICBcbj4oY29tcG9uZW50OiBDb21wb25lbnRDb250cm9sbGVyPFMsIFAsIE0+LCByZWNvcmQ6IEV4cHJlc3Npb25SZWNvcmQpe1xuXG5cbiAgICBpZighcmVjb3JkLmF0dHJpYnV0ZSAmJiByZWNvcmQudHlwZSA9PSAnYXR0cmlidXRlLmVjaG8nKXsgcmV0dXJuIHVuZGVmaW5lZDt9XG4gICAgXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHR5cGVvZiByZWNvcmQ+KChyZXNvbHZlLCByZWplY3QpPT57XG5cbiAgICAgICAgY29uc3QgbmFtZSA9IHJlY29yZC5hdHRyaWJ1dGU/Lm5hbWUgYXMgc3RyaW5nXG5cbiAgICAgICAgbGV0IG1vY2t1cCA9IChyZWNvcmQubW9ja3VwPy50ZXh0Q29udGVudCB8fCAnJykgYXMgc3RyaW5nO1xuICAgICAgICBcbiAgICAgICAgaWYocmVjb3JkLm1hdGNoKXtcblxuICAgICAgICAgICAgbW9ja3VwID0gbW9ja3VwLnJlcGxhY2UoIG5ldyBSZWdFeHAoIChyZWNvcmQubWF0Y2hbMF18fCcnKS5yZXBsYWNlKC9bXlxcd1xcc10vZ2ksICdcXFxcJCYnKSAsICdnJyApLCBgPCR7U3lEZXRyfT0keyByZWNvcmQubWF0Y2hbMV0gfSAke1N5RGV0cn0+YCApIFxuXG4gICAgICAgIH1cblxuICAgICAgICBSZW5kZXJFbmdpbmUobW9ja3VwLCBjb21wb25lbnQsIGNvbXBvbmVudC5zdGF0ZSkudGhlbihyZXN1bHQ9PntcblxuICAgICAgICAgICAgaWYoJ2F0dHJpYnV0ZXMnIGluIHJlY29yZC5ub2RlKXtcblxuICAgICAgICAgICAgICAgIHJlY29yZC5ub2RlLnNldEF0dHJpYnV0ZShuYW1lLCByZXN1bHQpO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJlc29sdmUocmVjb3JkKVxuXG4gICAgICAgIH0pLmNhdGNoKGVyPT57XG5cbiAgICAgICAgICAgIENvbXBpbGF0ZUVycm9yRXhjZXB0aW9uKGVyKVxuXG4gICAgICAgICAgICByZWplY3QoZXIpXG4gICAgICAgICAgICBcbiAgICAgICAgfSlcbiAgICAgICAgXG4gICAgfSlcbiAgICBcbiAgICBcbn1cblxuXG5cblxuXG5cbiJdfQ==