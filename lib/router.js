import { FxPresenter } from "./fx/preset";
const SensenWindow = {};
// export type RouterStates = {
//     [K : SceneActivityRouteName] : SensenSceneActivities
// }
export class SensenRouter {
    constructor(config) {
        this.routes = {};
        this.activity = {};
        this.root = {};
        this.config = config;
        this.initialize();
    }
    get(activity) {
        if (typeof activity.config?.route == 'string') {
            const key = activity.config.route;
            this.routes[key] = activity;
        }
        return this;
    }
    initialize() {
        this.canvas = (this.config.canvas instanceof HTMLElement)
            ? this.config.canvas
            : document.querySelector(this.config.canvas);
        return this;
    }
    clean() {
        if (this.canvas instanceof HTMLElement) {
            this.canvas.innerHTML = '';
        }
        return this;
    }
    render() {
        this.clean();
        window.addEventListener('hashchange', () => {
            const slug = (location.hash || '').substring(1);
            this.navigate(slug);
        });
        if (location.hash) {
            // console.warn('Go to view', location.hash.substring(1))
            this.navigate(location.hash.substring(1));
        }
        else if (this.config.default) {
            // console.warn('Go to default view', this.config.default)
            this.navigate(this.config.default);
        }
        else {
            alert('Router UnBoot, \nAjouter une route par default ');
        }
        return this;
    }
    parseSlug(slug) {
        const ex = (`${slug}`).split('?');
        return {
            name: ex[0],
            search: ex[1] || ''
        };
    }
    async navigate(slug, props) {
        const parsed = this.parseSlug(slug || this.config.default);
        return new Promise(async (resolve, reject) => {
            const activity = this.routes[parsed.name] || undefined;
            if (activity) {
                const firstTime = !activity.isReady ? true : false;
                const oldActivity = SensenWindow.$SceneActivity;
                activity.render(props);
                if (activity.$element instanceof HTMLElement && this.canvas instanceof HTMLElement) {
                    // console.warn('Set EXIT Animation on', SensenWindow.$SceneActivity )
                    // if(SensenWindow.$SceneActivity){
                    //     if(SensenWindow.$SceneActivity.config?.options?.transition){
                    //         console.log('Fx Transition', SensenWindow.$SceneActivity.config?.options?.transition)
                    //     }
                    // }
                    this.activity = activity;
                    if (this.activity.$element instanceof HTMLElement) {
                        this.canvas?.appendChild(this.activity.$element);
                        SensenWindow.$SceneActivity = activity;
                    }
                    /**
                     * Exit Reverse Transition
                     */
                    if (oldActivity && oldActivity.config?.options?.transition && firstTime) {
                        if (oldActivity.config.options.transition.exit instanceof FxPresenter) {
                            oldActivity.config?.options?.transition.exit.exitReverse(oldActivity.$element).then(r => {
                            }).catch(er => {
                                console.error('Transition Error', er);
                            });
                        }
                    }
                    /**
                     * Exit Reverse Transition
                     */
                    if (oldActivity && oldActivity.config?.options?.transition && !firstTime) {
                        if (oldActivity.config.options.transition.exit instanceof FxPresenter) {
                            oldActivity.config?.options?.transition.exit.exit(oldActivity.$element).then(r => {
                            }).catch(er => {
                                console.error('Transition Error', er);
                            });
                        }
                    }
                    /**
                     * Entry Reverse Transition
                     */
                    if (activity.config?.options?.transition && !firstTime) {
                        if (activity.config.options.transition.entry instanceof FxPresenter) {
                            activity.config?.options?.transition.entry.entryReverse(activity.$element).then(r => {
                                if (oldActivity && oldActivity.$element) {
                                    oldActivity.$element.innerHTML = '';
                                    oldActivity.isReady = false;
                                }
                            }).catch(er => {
                                console.error('Transition Error', er);
                            });
                        }
                    }
                    /**
                     * Entry Transition
                     */
                    if (activity.config?.options?.transition && firstTime) {
                        if (activity.config.options.transition.entry instanceof FxPresenter) {
                            activity.config?.options?.transition.entry.entry(activity.$element).then(r => {
                                if (oldActivity && oldActivity.$element) {
                                    oldActivity.$element.innerHTML = '';
                                }
                            }).catch(er => {
                                console.error('Transition Error', er);
                            });
                        }
                    }
                }
                else {
                    throw (`This activity has not available "$element" `);
                }
            }
            else {
                throw (`Sensen Router say route < \n${slug} > not found`);
            }
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vY29yZS9yb3V0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUkxQyxNQUFNLFlBQVksR0FBRyxFQUFtQixDQUFBO0FBcUJ4QywrQkFBK0I7QUFFL0IsMkRBQTJEO0FBRTNELElBQUk7QUFLSixNQUFNLE9BQU8sWUFBWTtJQW1CckIsWUFBWSxNQUFvQjtRQWRoQyxXQUFNLEdBSUYsRUFBOEMsQ0FBQztRQUVuRCxhQUFRLEdBQStCLEVBQWdDLENBQUE7UUFFdkUsU0FBSSxHQUFnQixFQUFpQixDQUFDO1FBUWxDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBRXJCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQTtJQUVyQixDQUFDO0lBSUQsR0FBRyxDQUErQixRQUE0QjtRQUUxRCxJQUFHLE9BQU8sUUFBUSxDQUFDLE1BQU0sRUFBRSxLQUFLLElBQUksUUFBUSxFQUFDO1lBRXpDLE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBZ0IsQ0FBQTtZQUU1QyxJQUFJLENBQUMsTUFBTSxDQUFFLEdBQUcsQ0FBRSxHQUFHLFFBQXNDLENBQUE7U0FFOUQ7UUFFRCxPQUFPLElBQUksQ0FBQztJQUVoQixDQUFDO0lBS0QsVUFBVTtRQUVOLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sWUFBWSxXQUFXLENBQUM7WUFFckQsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTTtZQUVwQixDQUFDLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUUvQztRQUdELE9BQU8sSUFBSSxDQUFDO0lBRWhCLENBQUM7SUFJRCxLQUFLO1FBRUQsSUFBRyxJQUFJLENBQUMsTUFBTSxZQUFZLFdBQVcs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QUssY0FBYyxDQUFDLENBQUE7YUFFOUQ7UUFFTCxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUM7Q0FJSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNjZW5lQWN0aXZpdHksIFNlbnNlblNjZW5lQWN0aXZpdGllcyB9IGZyb20gXCIuL2FjdGl2aXR5XCI7XG5pbXBvcnQgeyBTZW5zZW5GeEVuZ2luZSB9IGZyb20gXCIuL2Z4XCI7XG5pbXBvcnQgeyBGeFByZXNlbnRlciB9IGZyb20gXCIuL2Z4L3ByZXNldFwiO1xuaW1wb3J0IHsgU2NlbmVBY3Rpdml0eVByb3BzLCBTY2VuZUFjdGl2aXR5Um91dGVOYW1lLCBUU2Vuc2VuV2luZG93IH0gZnJvbSBcIi4vaW5kZXgudFwiO1xuXG5cbmNvbnN0IFNlbnNlbldpbmRvdyA9IHt9IGFzIFRTZW5zZW5XaW5kb3dcblxuXG5leHBvcnQgdHlwZSBSb3V0ZXJDb25maWcgPSB7XG5cbiAgICBkZWZhdWx0OiBzdHJpbmc7XG5cbiAgICBjYW52YXM6IHN0cmluZyB8IEhUTUxFbGVtZW50O1xuXG4gICAgYmFzZVVSTD86IHN0cmluZztcbiAgICBcbn1cblxuXG5pbnRlcmZhY2UgV2luZG93e1xuXG4gICAgU2NlbmVBY3Rpdml0eTogdHlwZW9mIFNjZW5lQWN0aXZpdHk7XG4gICAgXG59XG5cblxuLy8gZXhwb3J0IHR5cGUgUm91dGVyU3RhdGVzID0ge1xuXG4vLyAgICAgW0sgOiBTY2VuZUFjdGl2aXR5Um91dGVOYW1lXSA6IFNlbnNlblNjZW5lQWN0aXZpdGllc1xuXG4vLyB9XG5cblxuXG5cbmV4cG9ydCBjbGFzcyBTZW5zZW5Sb3V0ZXI8QiBleHRlbmRzIFNjZW5lQWN0aXZpdHlQcm9wcz57XG5cblxuICAgIGNvbmZpZzogUm91dGVyQ29uZmlnO1xuXG4gICAgcm91dGVzOiB7IFxuICAgICAgICBcbiAgICAgICAgW3ggaW4ga2V5b2YgQl0gOiBTY2VuZUFjdGl2aXR5PEJbeF0+IFxuICAgIFxuICAgIH0gPSB7fSBhcyB7IFt4IGluIGtleW9mIEJdIDogU2NlbmVBY3Rpdml0eTxCW3hdPiB9O1xuICAgIFxuICAgIGFjdGl2aXR5OiBTY2VuZUFjdGl2aXR5PEJbIHN0cmluZyBdPiA9IHt9IGFzIFNjZW5lQWN0aXZpdHk8Qlsgc3RyaW5nIF0+XG4gICAgXG4gICAgcm9vdDogSFRNTEVsZW1lbnQgPSB7fSBhcyBIVE1MRWxlbWVudDtcbiAgICBcbiAgICBjYW52YXM/OiBIVE1MRWxlbWVudCB8IG51bGw7XG5cblxuXG4gICAgY29uc3RydWN0b3IoY29uZmlnOiBSb3V0ZXJDb25maWcpe1xuXG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5pbml0aWFsaXplKClcbiAgICAgICAgXG4gICAgfVxuXG5cblxuICAgIGdldDxQIGV4dGVuZHMgU2NlbmVBY3Rpdml0eVByb3BzPihhY3Rpdml0eSA6ICBTY2VuZUFjdGl2aXR5PFA+ICl7XG5cbiAgICAgICAgaWYodHlwZW9mIGFjdGl2aXR5LmNvbmZpZz8ucm91dGUgPT0gJ3N0cmluZycpe1xuXG4gICAgICAgICAgICBjb25zdCBrZXkgPSBhY3Rpdml0eS5jb25maWcucm91dGUgYXMga2V5b2YgQlxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLnJvdXRlc1sga2V5IF0gPSBhY3Rpdml0eSBhcyBTY2VuZUFjdGl2aXR5PEJbIGtleW9mIEJdPlxuXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgXG4gICAgfVxuICAgIFxuXG5cblxuICAgIGluaXRpYWxpemUoKXtcblxuICAgICAgICB0aGlzLmNhbnZhcyA9ICh0aGlzLmNvbmZpZy5jYW52YXMgaW5zdGFuY2VvZiBIVE1MRWxlbWVudClcblxuICAgICAgICAgICAgPyB0aGlzLmNvbmZpZy5jYW52YXNcblxuICAgICAgICAgICAgOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHRoaXMuY29uZmlnLmNhbnZhcylcblxuICAgICAgICA7XG5cbiAgICAgICAgXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICBcbiAgICB9XG4gICAgXG5cblxuICAgIGNsZWFuKCl7XG5cbiAgICAgICAgaWYodGhpcy5jYW52YXMgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCl7XG5cbiAgICAgICAgICAgIHRoaXMuY2FudmFzLmlubmVySFRNTCA9ICcnXG5cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIFxuICAgIH1cbiAgICBcblxuXG4gICAgcmVuZGVyKCl7XG5cbiAgICAgICAgdGhpcy5jbGVhbigpO1xuICAgICAgICBcbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2hhc2hjaGFuZ2UnLCAoKT0+e1xuXG4gICAgICAgICAgICBjb25zdCBzbHVnID0gKGxvY2F0aW9uLmhhc2ggfHwgJycpLnN1YnN0cmluZygxKTtcblxuICAgICAgICAgICAgdGhpcy5uYXZpZ2F0ZShzbHVnKVxuICAgICAgICAgICAgXG4gICAgICAgIH0pXG5cbiAgICAgICAgXG4gICAgICAgIGlmKGxvY2F0aW9uLmhhc2gpe1xuXG4gICAgICAgICAgICAvLyBjb25zb2xlLndhcm4oJ0dvIHRvIHZpZXcnLCBsb2NhdGlvbi5oYXNoLnN1YnN0cmluZygxKSlcblxuICAgICAgICAgICAgdGhpcy5uYXZpZ2F0ZShsb2NhdGlvbi5oYXNoLnN1YnN0cmluZygxKSlcblxuICAgICAgICB9XG5cbiAgICAgICAgZWxzZSBpZih0aGlzLmNvbmZpZy5kZWZhdWx0KXtcblxuICAgICAgICAgICAgLy8gY29uc29sZS53YXJuKCdHbyB0byBkZWZhdWx0IHZpZXcnLCB0aGlzLmNvbmZpZy5kZWZhdWx0KVxuXG4gICAgICAgICAgICB0aGlzLm5hdmlnYXRlKHRoaXMuY29uZmlnLmRlZmF1bHQpXG4gICAgICAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIGVsc2V7XG5cbiAgICAgICAgICAgIGFsZXJ0KCdSb3V0ZXIgVW5Cb290LCBcXG5Bam91dGVyIHVuZSByb3V0ZSBwYXIgZGVmYXVsdCAnKVxuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiB0aGlzO1xuXG4gICAgfVxuXG5cblxuICAgIHBhcnNlU2x1ZyhzbHVnOiBrZXlvZiBCKXtcblxuICAgICAgICBjb25zdCBleCA9IChgJHsgc2x1ZyB9YCkuc3BsaXQoJz8nKVxuXG4gICAgICAgIHJldHVybiB7XG5cbiAgICAgICAgICAgIG5hbWU6IGV4WzBdLFxuXG4gICAgICAgICAgICBzZWFyY2g6IGV4WzFdfHwnJ1xuXG4gICAgICAgIH1cblxuICAgIH1cbiAgICBcbiAgICBcblxuICAgIGFzeW5jIG5hdmlnYXRlKHNsdWc6IGtleW9mIEIsIHByb3BzPzoge1xuICAgICAgICBbSyBpbiBrZXlvZiBCXSA/OiBhbnlcbiAgICB9KXtcblxuICAgICAgICBjb25zdCBwYXJzZWQgPSB0aGlzLnBhcnNlU2x1ZyhzbHVnIHx8IHRoaXMuY29uZmlnLmRlZmF1bHQpXG5cbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8dHlwZW9mIFNjZW5lQWN0aXZpdHk+KGFzeW5jIChyZXNvbHZlOiBGdW5jdGlvbiwgcmVqZWN0OiBGdW5jdGlvbik9PntcbiAgICBcbiAgICAgICAgICAgY29uc3QgYWN0aXZpdHkgPSB0aGlzLnJvdXRlc1sgcGFyc2VkLm5hbWUgXSB8fCB1bmRlZmluZWQ7XG5cblxuICAgICAgICAgICAgaWYoYWN0aXZpdHkpe1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbnN0IGZpcnN0VGltZSA9ICFhY3Rpdml0eS5pc1JlYWR5ID8gdHJ1ZSA6IGZhbHNlO1xuXG4gICAgICAgICAgICAgICAgY29uc3Qgb2xkQWN0aXZpdHkgPSBTZW5zZW5XaW5kb3cuJFNjZW5lQWN0aXZpdHk7XG4gICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgICAgICBhY3Rpdml0eS5yZW5kZXIocHJvcHMgYXMgQlsga2V5b2YgQl0pXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYoYWN0aXZpdHkuJGVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCAmJiB0aGlzLmNhbnZhcyBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KXtcblxuXG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS53YXJuKCdTZXQgRVhJVCBBbmltYXRpb24gb24nLCBTZW5zZW5XaW5kb3cuJFNjZW5lQWN0aXZpdHkgKVxuXG4gICAgICAgICAgICAgICAgICAgIC8vIGlmKFNlbnNlbldpbmRvdy4kU2NlbmVBY3Rpdml0eSl7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIGlmKFNlbnNlbldpbmRvdy4kU2NlbmVBY3Rpdml0eS5jb25maWc/Lm9wdGlvbnM/LnRyYW5zaXRpb24pe1xuXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgY29uc29sZS5sb2coJ0Z4IFRyYW5zaXRpb24nLCBTZW5zZW5XaW5kb3cuJFNjZW5lQWN0aXZpdHkuY29uZmlnPy5vcHRpb25zPy50cmFuc2l0aW9uKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gfVxuICAgICAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpdml0eSA9IGFjdGl2aXR5O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYWN0aXZpdHkuJGVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCl7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW52YXM/LmFwcGVuZENoaWxkKHRoaXMuYWN0aXZpdHkuJGVsZW1lbnQpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBTZW5zZW5XaW5kb3cuJFNjZW5lQWN0aXZpdHkgPSBhY3Rpdml0eSBhcyBTY2VuZUFjdGl2aXR5PFNjZW5lQWN0aXZpdHlQcm9wcz47XG5cbiAgICAgICAgICAgICAgICAgICAgfVxuXG5cblxuICAgICAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgICAgICogRXhpdCBSZXZlcnNlIFRyYW5zaXRpb25cbiAgICAgICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgICAgIGlmKG9sZEFjdGl2aXR5ICYmIG9sZEFjdGl2aXR5LmNvbmZpZz8ub3B0aW9ucz8udHJhbnNpdGlvbiAmJiBmaXJzdFRpbWUpe1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihvbGRBY3Rpdml0eS5jb25maWcub3B0aW9ucy50cmFuc2l0aW9uLmV4aXQgaW5zdGFuY2VvZiBGeFByZXNlbnRlcil7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRBY3Rpdml0eS5jb25maWc/Lm9wdGlvbnM/LnRyYW5zaXRpb24uZXhpdC5leGl0UmV2ZXJzZShcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRBY3Rpdml0eS4kZWxlbWVudFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLnRoZW4ocj0+e1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZXI9PntcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdUcmFuc2l0aW9uIEVycm9yJywgZXIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICAgICAqIEV4aXQgUmV2ZXJzZSBUcmFuc2l0aW9uXG4gICAgICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgICAgICBpZihvbGRBY3Rpdml0eSAmJiBvbGRBY3Rpdml0eS5jb25maWc/Lm9wdGlvbnM/LnRyYW5zaXRpb24gJiYgIWZpcnN0VGltZSl7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG9sZEFjdGl2aXR5LmNvbmZpZy5vcHRpb25zLnRyYW5zaXRpb24uZXhpdCBpbnN0YW5jZW9mIEZ4UHJlc2VudGVyKXtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZEFjdGl2aXR5LmNvbmZpZz8ub3B0aW9ucz8udHJhbnNpdGlvbi5leGl0LmV4aXQoXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkQWN0aXZpdHkuJGVsZW1lbnRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKS50aGVuKHI9PntcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGVyPT57XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignVHJhbnNpdGlvbiBFcnJvcicsIGVyKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAgICAgKiBFbnRyeSBSZXZlcnNlIFRyYW5zaXRpb25cbiAgICAgICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgICAgIGlmKGFjdGl2aXR5LmNvbmZpZz8ub3B0aW9ucz8udHJhbnNpdGlvbiAmJiAhZmlyc3RUaW1lKXtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoYWN0aXZpdHkuY29uZmlnLm9wdGlvbnMudHJhbnNpdGlvbi5lbnRyeSBpbnN0YW5jZW9mIEZ4UHJlc2VudGVyKXtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5LmNvbmZpZz8ub3B0aW9ucz8udHJhbnNpdGlvbi5lbnRyeS5lbnRyeVJldmVyc2UoXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHkuJGVsZW1lbnRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKS50aGVuKHI9PntcblxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG9sZEFjdGl2aXR5ICYmIG9sZEFjdGl2aXR5LiRlbGVtZW50KXsgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZEFjdGl2aXR5LiRlbGVtZW50LmlubmVySFRNTCA9ICcnIFxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRBY3Rpdml0eS5pc1JlYWR5ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGVyPT57XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignVHJhbnNpdGlvbiBFcnJvcicsIGVyKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAgICAgKiBFbnRyeSBUcmFuc2l0aW9uXG4gICAgICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgICAgICBpZihhY3Rpdml0eS5jb25maWc/Lm9wdGlvbnM/LnRyYW5zaXRpb24gJiYgZmlyc3RUaW1lKXtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoYWN0aXZpdHkuY29uZmlnLm9wdGlvbnMudHJhbnNpdGlvbi5lbnRyeSBpbnN0YW5jZW9mIEZ4UHJlc2VudGVyKXtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5LmNvbmZpZz8ub3B0aW9ucz8udHJhbnNpdGlvbi5lbnRyeS5lbnRyeShcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eS4kZWxlbWVudFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLnRoZW4ocj0+e1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG9sZEFjdGl2aXR5ICYmIG9sZEFjdGl2aXR5LiRlbGVtZW50KXsgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZEFjdGl2aXR5LiRlbGVtZW50LmlubmVySFRNTCA9ICcnIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaChlcj0+e1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1RyYW5zaXRpb24gRXJyb3InLCBlcilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGVsc2V7XG5cbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgKGBUaGlzIGFjdGl2aXR5IGhhcyBub3QgYXZhaWxhYmxlIFwiJGVsZW1lbnRcIiBgKVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZWxzZXtcblxuICAgICAgICAgICAgICAgIHRocm93IChgU2Vuc2VuIFJvdXRlciBzYXkgcm91dGUgPCBcXG4keyBzbHVnIH0gPiBub3QgZm91bmRgKVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgfVxuXG4gICAgXG4gICAgXG59XG5cbiJdfQ==